// Touched only once, it's from sharejs code base for browser channel
// User reported edits loss, browser channel timed out after 10 ~ 15 seconds, there was one change by Endri to enlarge the timeout.

(function(){
var f,aa=aa||{},l=this;function ba(a){a=a.split(".");for(var b=l,c;c=a.shift();)if(null!=b[c])b=b[c];else return null;return b}function ca(){}
function da(a){var b=typeof a;if("object"==b)if(a){if(a instanceof Array)return"array";if(a instanceof Object)return b;var c=Object.prototype.toString.call(a);if("[object Window]"==c)return"object";if("[object Array]"==c||"number"==typeof a.length&&"undefined"!=typeof a.splice&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("splice"))return"array";if("[object Function]"==c||"undefined"!=typeof a.call&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("call"))return"function"}else return"null";
else if("function"==b&&"undefined"==typeof a.call)return"object";return b}function m(a){return"array"==da(a)}function ea(a){var b=da(a);return"array"==b||"object"==b&&"number"==typeof a.length}function n(a){return"string"==typeof a}function fa(a){return"function"==da(a)}var ga="closure_uid_"+(1E9*Math.random()>>>0),ha=0;function ia(a,b,c){return a.call.apply(a.bind,arguments)}
function ja(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c)}}return function(){return a.apply(b,arguments)}}function p(a,b,c){p=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ia:ja;return p.apply(null,arguments)}var q=Date.now||function(){return+new Date};
function s(a,b){function c(){}c.prototype=b.prototype;a.pa=b.prototype;a.prototype=new c;a.Hc=function(a,c,g){var h=Array.prototype.slice.call(arguments,2);return b.prototype[c].apply(a,h)}};function ka(a,b){for(var c=a.split("%s"),d="",e=Array.prototype.slice.call(arguments,1);e.length&&1<c.length;)d+=c.shift()+e.shift();return d+c.join("%s")}function la(a){if(!ma.test(a))return a;-1!=a.indexOf("&")&&(a=a.replace(na,"&amp;"));-1!=a.indexOf("<")&&(a=a.replace(oa,"&lt;"));-1!=a.indexOf(">")&&(a=a.replace(pa,"&gt;"));-1!=a.indexOf('"')&&(a=a.replace(qa,"&quot;"));-1!=a.indexOf("'")&&(a=a.replace(ra,"&#39;"));return a}var na=/&/g,oa=/</g,pa=/>/g,qa=/"/g,ra=/'/g,ma=/[&<>"']/;
function sa(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^q()).toString(36)}function ta(a,b){return a<b?-1:a>b?1:0};var x,ua,va,wa;function xa(){return l.navigator?l.navigator.userAgent:null}wa=va=ua=x=!1;var ya;if(ya=xa()){var za=l.navigator;x=0==ya.lastIndexOf("Opera",0);ua=!x&&(-1!=ya.indexOf("MSIE")||-1!=ya.indexOf("Trident"));va=!x&&-1!=ya.indexOf("WebKit");wa=!x&&!va&&!ua&&"Gecko"==za.product}var Aa=x,y=ua,Ba=wa,z=va;function Ca(){var a=l.document;return a?a.documentMode:void 0}var Da;
a:{var Ea="",Fa;if(Aa&&l.opera)var Ga=l.opera.version,Ea="function"==typeof Ga?Ga():Ga;else if(Ba?Fa=/rv\:([^\);]+)(\)|;)/:y?Fa=/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/:z&&(Fa=/WebKit\/(\S+)/),Fa)var Ha=Fa.exec(xa()),Ea=Ha?Ha[1]:"";if(y){var Ia=Ca();if(Ia>parseFloat(Ea)){Da=String(Ia);break a}}Da=Ea}var Ja={};
function A(a){var b;if(!(b=Ja[a])){b=0;for(var c=String(Da).replace(/^[\s\xa0]+|[\s\xa0]+$/g,"").split("."),d=String(a).replace(/^[\s\xa0]+|[\s\xa0]+$/g,"").split("."),e=Math.max(c.length,d.length),g=0;0==b&&g<e;g++){var h=c[g]||"",k=d[g]||"",u=RegExp("(\\d*)(\\D*)","g"),K=RegExp("(\\d*)(\\D*)","g");do{var v=u.exec(h)||["","",""],r=K.exec(k)||["","",""];if(0==v[0].length&&0==r[0].length)break;b=ta(0==v[1].length?0:parseInt(v[1],10),0==r[1].length?0:parseInt(r[1],10))||ta(0==v[2].length,0==r[2].length)||
ta(v[2],r[2])}while(0==b)}b=Ja[a]=0<=b}return b}var La=l.document,Ma=La&&y?Ca()||("CSS1Compat"==La.compatMode?parseInt(Da,10):5):void 0;function Na(a){Error.captureStackTrace?Error.captureStackTrace(this,Na):this.stack=Error().stack||"";a&&(this.message=String(a))}s(Na,Error);Na.prototype.name="CustomError";function Oa(a,b){b.unshift(a);Na.call(this,ka.apply(null,b));b.shift()}s(Oa,Na);Oa.prototype.name="AssertionError";function Pa(a,b){throw new Oa("Failure"+(a?": "+a:""),Array.prototype.slice.call(arguments,1));};var Qa=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$");function Ra(a){if(Sa){Sa=!1;var b=l.location;if(b){var c=b.href;if(c&&(c=(c=Ra(c)[3]||null)&&decodeURIComponent(c))&&c!=b.hostname)throw Sa=!0,Error();}}return a.match(Qa)}var Sa=z;function Ta(a){var b=[],c=0,d;for(d in a)b[c++]=a[d];return b}function Ua(a){var b=[],c=0,d;for(d in a)b[c++]=d;return b}var Va="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Wa(a,b){for(var c,d,e=1;e<arguments.length;e++){d=arguments[e];for(c in d)a[c]=d[c];for(var g=0;g<Va.length;g++)c=Va[g],Object.prototype.hasOwnProperty.call(d,c)&&(a[c]=d[c])}};var B=Array.prototype,Xa=B.indexOf?function(a,b,c){return B.indexOf.call(a,b,c)}:function(a,b,c){c=null==c?0:0>c?Math.max(0,a.length+c):c;if(n(a))return n(b)&&1==b.length?a.indexOf(b,c):-1;for(;c<a.length;c++)if(c in a&&a[c]===b)return c;return-1},Ya=B.forEach?function(a,b,c){B.forEach.call(a,b,c)}:function(a,b,c){for(var d=a.length,e=n(a)?a.split(""):a,g=0;g<d;g++)g in e&&b.call(c,e[g],g,a)};
function Za(a){var b;a:{b=$a;for(var c=a.length,d=n(a)?a.split(""):a,e=0;e<c;e++)if(e in d&&b.call(void 0,d[e],e,a)){b=e;break a}b=-1}return 0>b?null:n(a)?a.charAt(b):a[b]}function ab(a){return B.concat.apply(B,arguments)}function bb(a){var b=a.length;if(0<b){for(var c=Array(b),d=0;d<b;d++)c[d]=a[d];return c}return[]};function cb(a,b){this.O={};this.j=[];this.o=0;var c=arguments.length;if(1<c){if(c%2)throw Error("Uneven number of arguments");for(var d=0;d<c;d+=2)this.set(arguments[d],arguments[d+1])}else if(a){a instanceof cb?(c=a.ca(),d=a.N()):(c=Ua(a),d=Ta(a));for(var e=0;e<c.length;e++)this.set(c[e],d[e])}}f=cb.prototype;f.N=function(){db(this);for(var a=[],b=0;b<this.j.length;b++)a.push(this.O[this.j[b]]);return a};f.ca=function(){db(this);return this.j.concat()};f.wa=function(a){return C(this.O,a)};
f.remove=function(a){return C(this.O,a)?(delete this.O[a],this.o--,this.j.length>2*this.o&&db(this),!0):!1};function db(a){if(a.o!=a.j.length){for(var b=0,c=0;b<a.j.length;){var d=a.j[b];C(a.O,d)&&(a.j[c++]=d);b++}a.j.length=c}if(a.o!=a.j.length){for(var e={},c=b=0;b<a.j.length;)d=a.j[b],C(e,d)||(a.j[c++]=d,e[d]=1),b++;a.j.length=c}}f.get=function(a,b){return C(this.O,a)?this.O[a]:b};f.set=function(a,b){C(this.O,a)||(this.o++,this.j.push(a));this.O[a]=b};f.n=function(){return new cb(this)};
function C(a,b){return Object.prototype.hasOwnProperty.call(a,b)};function eb(a){if("function"==typeof a.N)return a.N();if(n(a))return a.split("");if(ea(a)){for(var b=[],c=a.length,d=0;d<c;d++)b.push(a[d]);return b}return Ta(a)}function D(a,b,c){if("function"==typeof a.forEach)a.forEach(b,c);else if(ea(a)||n(a))Ya(a,b,c);else{var d;if("function"==typeof a.ca)d=a.ca();else if("function"!=typeof a.N)if(ea(a)||n(a)){d=[];for(var e=a.length,g=0;g<e;g++)d.push(g)}else d=Ua(a);else d=void 0;for(var e=eb(a),g=e.length,h=0;h<g;h++)b.call(c,e[h],d&&d[h],a)}};function E(a,b){var c;if(a instanceof E)this.D=void 0!==b?b:a.D,fb(this,a.oa),c=a.eb,F(this),this.eb=c,gb(this,a.ja),hb(this,a.Ca),ib(this,a.I),jb(this,a.R.n()),c=a.Na,F(this),this.Na=c;else if(a&&(c=Ra(String(a)))){this.D=!!b;fb(this,c[1]||"",!0);var d=c[2]||"";F(this);this.eb=d?decodeURIComponent(d):"";gb(this,c[3]||"",!0);hb(this,c[4]);ib(this,c[5]||"",!0);jb(this,c[6]||"",!0);c=c[7]||"";F(this);this.Na=c?decodeURIComponent(c):""}else this.D=!!b,this.R=new kb(null,0,this.D)}f=E.prototype;
f.oa="";f.eb="";f.ja="";f.Ca=null;f.I="";f.Na="";f.oc=!1;f.D=!1;f.toString=function(){var a=[],b=this.oa;b&&a.push(lb(b,mb),":");if(b=this.ja){a.push("//");var c=this.eb;c&&a.push(lb(c,mb),"@");a.push(encodeURIComponent(String(b)));b=this.Ca;null!=b&&a.push(":",String(b))}if(b=this.I)this.ja&&"/"!=b.charAt(0)&&a.push("/"),a.push(lb(b,"/"==b.charAt(0)?nb:ob));(b=this.R.toString())&&a.push("?",b);(b=this.Na)&&a.push("#",lb(b,pb));return a.join("")};f.n=function(){return new E(this)};
function fb(a,b,c){F(a);a.oa=c?b?decodeURIComponent(b):"":b;a.oa&&(a.oa=a.oa.replace(/:$/,""))}function gb(a,b,c){F(a);a.ja=c?b?decodeURIComponent(b):"":b}function hb(a,b){F(a);if(b){b=Number(b);if(isNaN(b)||0>b)throw Error("Bad port number "+b);a.Ca=b}else a.Ca=null}function ib(a,b,c){F(a);a.I=c?b?decodeURIComponent(b):"":b}function jb(a,b,c){F(a);b instanceof kb?(a.R=b,a.R.ub(a.D)):(c||(b=lb(b,qb)),a.R=new kb(b,0,a.D))}function G(a,b,c){F(a);a.R.set(b,c)}
function rb(a,b,c){F(a);m(c)||(c=[String(c)]);sb(a.R,b,c)}function H(a){F(a);G(a,"zx",sa());return a}function F(a){if(a.oc)throw Error("Tried to modify a read-only Uri");}f.ub=function(a){this.D=a;this.R&&this.R.ub(a);return this};function tb(a){return a instanceof E?a.n():new E(a,void 0)}function ub(a,b,c,d){var e=new E(null,void 0);a&&fb(e,a);b&&gb(e,b);c&&hb(e,c);d&&ib(e,d);return e}function lb(a,b){return n(a)?encodeURI(a).replace(b,vb):null}
function vb(a){a=a.charCodeAt(0);return"%"+(a>>4&15).toString(16)+(a&15).toString(16)}var mb=/[#\/\?@]/g,ob=/[\#\?:]/g,nb=/[\#\?]/g,qb=/[\#\?@]/g,pb=/#/g;function kb(a,b,c){this.C=a||null;this.D=!!c}function I(a){if(!a.h&&(a.h=new cb,a.o=0,a.C))for(var b=a.C.split("&"),c=0;c<b.length;c++){var d=b[c].indexOf("="),e=null,g=null;0<=d?(e=b[c].substring(0,d),g=b[c].substring(d+1)):e=b[c];e=decodeURIComponent(e.replace(/\+/g," "));e=J(a,e);a.add(e,g?decodeURIComponent(g.replace(/\+/g," ")):"")}}f=kb.prototype;
f.h=null;f.o=null;f.add=function(a,b){I(this);this.C=null;a=J(this,a);var c=this.h.get(a);c||this.h.set(a,c=[]);c.push(b);this.o++;return this};f.remove=function(a){I(this);a=J(this,a);return this.h.wa(a)?(this.C=null,this.o-=this.h.get(a).length,this.h.remove(a)):!1};f.wa=function(a){I(this);a=J(this,a);return this.h.wa(a)};f.ca=function(){I(this);for(var a=this.h.N(),b=this.h.ca(),c=[],d=0;d<b.length;d++)for(var e=a[d],g=0;g<e.length;g++)c.push(b[d]);return c};
f.N=function(a){I(this);var b=[];if(n(a))this.wa(a)&&(b=ab(b,this.h.get(J(this,a))));else{a=this.h.N();for(var c=0;c<a.length;c++)b=ab(b,a[c])}return b};f.set=function(a,b){I(this);this.C=null;a=J(this,a);this.wa(a)&&(this.o-=this.h.get(a).length);this.h.set(a,[b]);this.o++;return this};f.get=function(a,b){var c=a?this.N(a):[];return 0<c.length?String(c[0]):b};function sb(a,b,c){a.remove(b);0<c.length&&(a.C=null,a.h.set(J(a,b),bb(c)),a.o+=c.length)}
f.toString=function(){if(this.C)return this.C;if(!this.h)return"";for(var a=[],b=this.h.ca(),c=0;c<b.length;c++)for(var d=b[c],e=encodeURIComponent(String(d)),d=this.N(d),g=0;g<d.length;g++){var h=e;""!==d[g]&&(h+="="+encodeURIComponent(String(d[g])));a.push(h)}return this.C=a.join("&")};f.n=function(){var a=new kb;a.C=this.C;this.h&&(a.h=this.h.n(),a.o=this.o);return a};function J(a,b){var c=String(b);a.D&&(c=c.toLowerCase());return c}
f.ub=function(a){a&&!this.D&&(I(this),this.C=null,D(this.h,function(a,c){var d=c.toLowerCase();c!=d&&(this.remove(c),sb(this,d,a))},this));this.D=a};function wb(a){a=String(a);if(/^\s*$/.test(a)?0:/^[\],:{}\s\u2028\u2029]*$/.test(a.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r\u2028\u2029\x00-\x08\x0a-\x1f]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:[\s\u2028\u2029]*\[)+/g,"")))try{return eval("("+a+")")}catch(b){}throw Error("Invalid JSON string: "+a);}function xb(a){return eval("("+a+")")}function yb(a){var b=[];zb(new Ab,a,b);return b.join("")}function Ab(){this.Ya=void 0}
function zb(a,b,c){switch(typeof b){case "string":Bb(b,c);break;case "number":c.push(isFinite(b)&&!isNaN(b)?b:"null");break;case "boolean":c.push(b);break;case "undefined":c.push("null");break;case "object":if(null==b){c.push("null");break}if(m(b)){var d=b.length;c.push("[");for(var e="",g=0;g<d;g++)c.push(e),e=b[g],zb(a,a.Ya?a.Ya.call(b,String(g),e):e,c),e=",";c.push("]");break}c.push("{");d="";for(g in b)Object.prototype.hasOwnProperty.call(b,g)&&(e=b[g],"function"!=typeof e&&(c.push(d),Bb(g,c),
c.push(":"),zb(a,a.Ya?a.Ya.call(b,g,e):e,c),d=","));c.push("}");break;case "function":break;default:throw Error("Unknown type: "+typeof b);}}var Cb={'"':'\\"',"\\":"\\\\","/":"\\/","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\x0B":"\\u000b"},Db=/\uffff/.test("\uffff")?/[\\\"\x00-\x1f\x7f-\uffff]/g:/[\\\"\x00-\x1f\x7f-\xff]/g;
function Bb(a,b){b.push('"',a.replace(Db,function(a){if(a in Cb)return Cb[a];var b=a.charCodeAt(0),e="\\u";16>b?e+="000":256>b?e+="00":4096>b&&(e+="0");return Cb[a]=e+b.toString(16)}),'"')};function Eb(a){return Fb(a||arguments.callee.caller,[])}
function Fb(a,b){var c=[];if(0<=Xa(b,a))c.push("[...circular reference...]");else if(a&&50>b.length){c.push(Gb(a)+"(");for(var d=a.arguments,e=0;e<d.length;e++){0<e&&c.push(", ");var g;g=d[e];switch(typeof g){case "object":g=g?"object":"null";break;case "string":break;case "number":g=String(g);break;case "boolean":g=g?"true":"false";break;case "function":g=(g=Gb(g))?g:"[fn]";break;default:g=typeof g}40<g.length&&(g=g.substr(0,40)+"...");c.push(g)}b.push(a);c.push(")\n");try{c.push(Fb(a.caller,b))}catch(h){c.push("[exception trying to get caller]\n")}}else a?
c.push("[...long stack...]"):c.push("[end]");return c.join("")}function Gb(a){if(Hb[a])return Hb[a];a=String(a);if(!Hb[a]){var b=/function ([^\(]+)/.exec(a);Hb[a]=b?b[1]:"[Anonymous]"}return Hb[a]}var Hb={};function Ib(a,b,c,d,e){this.reset(a,b,c,d,e)}Ib.prototype.Fb=null;Ib.prototype.Eb=null;var Jb=0;Ib.prototype.reset=function(a,b,c,d,e){"number"==typeof e||Jb++;d||q();this.Aa=a;this.qc=b;delete this.Fb;delete this.Eb};Ib.prototype.$b=function(a){this.Aa=a};function L(a){this.rc=a}L.prototype.Sa=null;L.prototype.Aa=null;L.prototype.jb=null;L.prototype.Jb=null;function Kb(a,b){this.name=a;this.value=b}Kb.prototype.toString=function(){return this.name};var Lb=new Kb("SEVERE",1E3),Mb=new Kb("WARNING",900),Nb=new Kb("INFO",800),Ob=new Kb("CONFIG",700),Pb=new Kb("FINE",500);f=L.prototype;f.getParent=function(){return this.Sa};f.$b=function(a){this.Aa=a};
function Qb(a){if(a.Aa)return a.Aa;if(a.Sa)return Qb(a.Sa);Pa("Root logger has no level set.");return null}f.log=function(a,b,c){if(a.value>=Qb(this).value)for(fa(b)&&(b=b()),a=this.mc(a,b,c),b="log:"+a.qc,l.console&&(l.console.timeStamp?l.console.timeStamp(b):l.console.markTimeline&&l.console.markTimeline(b)),l.msWriteProfilerMark&&l.msWriteProfilerMark(b),b=this;b;){c=b;var d=a;if(c.Jb)for(var e=0,g=void 0;g=c.Jb[e];e++)g(d);b=b.getParent()}};
f.mc=function(a,b,c){var d=new Ib(a,String(b),this.rc);if(c){d.Fb=c;var e;var g=arguments.callee.caller;try{var h;var k=ba("window.location.href");if(n(c))h={message:c,name:"Unknown error",lineNumber:"Not available",fileName:k,stack:"Not available"};else{var u,K,v=!1;try{u=c.lineNumber||c.Ic||"Not available"}catch(r){u="Not available",v=!0}try{K=c.fileName||c.filename||c.sourceURL||l.$googDebugFname||k}catch(Ka){K="Not available",v=!0}h=!v&&c.lineNumber&&c.fileName&&c.stack&&c.message&&c.name?c:{message:c.message||
"Not available",name:c.name||"UnknownError",lineNumber:u,fileName:K,stack:c.stack||"Not available"}}e="Message: "+la(h.message)+'\nUrl: <a href="view-source:'+h.fileName+'" target="_new">'+h.fileName+"</a>\nLine: "+h.lineNumber+"\n\nBrowser stack:\n"+la(h.stack+"-> ")+"[end]\n\nJS stack traversal:\n"+la(Eb(g)+"-> ")}catch(w){e="Exception trying to expose exception! You win, we lose. "+w}d.Eb=e}return d};f.J=function(a,b){this.log(Lb,a,b)};f.Z=function(a,b){this.log(Mb,a,b)};
f.info=function(a,b){this.log(Nb,a,b)};var Rb={},Sb=null;function Tb(a){Sb||(Sb=new L(""),Rb[""]=Sb,Sb.$b(Ob));var b;if(!(b=Rb[a])){b=new L(a);var c=a.lastIndexOf("."),d=a.substr(c+1),c=Tb(a.substr(0,c));c.jb||(c.jb={});c.jb[d]=b;b.Sa=c;Rb[a]=b}return b};function M(a,b){a&&a.log(Pb,b,void 0)};function N(){this.r=Tb("goog.net.BrowserChannel")}function Ub(a,b,c,d){a.info("XMLHTTP TEXT ("+b+"): "+Vb(a,c)+(d?" "+d:""))}N.prototype.debug=function(a){this.info(a)};function Wb(a,b,c){a.J((c||"Exception")+b)}N.prototype.info=function(a){var b=this.r;b&&b.info(a,void 0)};N.prototype.Z=function(a){var b=this.r;b&&b.Z(a,void 0)};N.prototype.J=function(a){var b=this.r;b&&b.J(a,void 0)};
function Vb(a,b){if(!b||b==Xb)return b;try{var c=xb(b);if(c)for(var d=0;d<c.length;d++)if(m(c[d])){var e=c[d];if(!(2>e.length)){var g=e[1];if(m(g)&&!(1>g.length)){var h=g[0];if("noop"!=h&&"stop"!=h)for(var k=1;k<g.length;k++)g[k]=""}}}return yb(c)}catch(u){return a.debug("Exception parsing expected JS array - probably was not JS"),b}};function Yb(a,b){this.P=b?xb:wb}Yb.prototype.parse=function(a){return this.P(a)};function O(){0!=Zb&&($b[this[ga]||(this[ga]=++ha)]=this)}var Zb=0,$b={};O.prototype.mb=!1;O.prototype.Ja=function(){if(!this.mb&&(this.mb=!0,this.u(),0!=Zb)){var a=this[ga]||(this[ga]=++ha);delete $b[a]}};O.prototype.u=function(){if(this.Pb)for(;this.Pb.length;)this.Pb.shift()()};var ac="closure_listenable_"+(1E6*Math.random()|0);function bc(a){try{return!(!a||!a[ac])}catch(b){return!1}}var cc=0;function dc(a,b,c,d,e){this.fa=a;this.Ua=null;this.src=b;this.type=c;this.capture=!!d;this.Oa=e;this.key=++cc;this.na=this.Ia=!1}function ec(a){a.na=!0;a.fa=null;a.Ua=null;a.src=null;a.Oa=null};function P(a){this.src=a;this.s={};this.Ga=0}P.prototype.add=function(a,b,c,d,e){var g=this.s[a];g||(g=this.s[a]=[],this.Ga++);var h=fc(g,b,d,e);-1<h?(a=g[h],c||(a.Ia=!1)):(a=new dc(b,this.src,a,!!d,e),a.Ia=c,g.push(a));return a};P.prototype.remove=function(a,b,c,d){if(!(a in this.s))return!1;var e=this.s[a];b=fc(e,b,c,d);return-1<b?(ec(e[b]),B.splice.call(e,b,1),0==e.length&&(delete this.s[a],this.Ga--),!0):!1};
function gc(a,b){var c=b.type;if(!(c in a.s))return!1;var d=a.s[c],e=Xa(d,b),g;(g=0<=e)&&B.splice.call(d,e,1);g&&(ec(b),0==a.s[c].length&&(delete a.s[c],a.Ga--));return g}P.prototype.Xa=function(a){var b=0,c;for(c in this.s)if(!a||c==a){for(var d=this.s[c],e=0;e<d.length;e++)++b,ec(d[e]);delete this.s[c];this.Ga--}return b};P.prototype.ya=function(a,b,c,d){a=this.s[a];var e=-1;a&&(e=fc(a,b,c,d));return-1<e?a[e]:null};
function fc(a,b,c,d){for(var e=0;e<a.length;++e){var g=a[e];if(!g.na&&g.fa==b&&g.capture==!!c&&g.Oa==d)return e}return-1};var hc=!y||y&&9<=Ma,ic=y&&!A("9");!z||A("528");Ba&&A("1.9b")||y&&A("8")||Aa&&A("9.5")||z&&A("528");Ba&&!A("8")||y&&A("9");function Q(a,b){this.type=a;this.currentTarget=this.target=b}f=Q.prototype;f.u=function(){};f.Ja=function(){};f.ga=!1;f.defaultPrevented=!1;f.Yb=!0;f.preventDefault=function(){this.defaultPrevented=!0;this.Yb=!1};function jc(a){jc[" "](a);return a}jc[" "]=ca;function kc(a,b){Q.call(this,a?a.type:"");this.relatedTarget=this.currentTarget=this.target=null;this.charCode=this.keyCode=this.button=this.screenY=this.screenX=this.clientY=this.clientX=this.offsetY=this.offsetX=0;this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1;this.Db=this.state=null;if(a){var c=this.type=a.type;this.target=a.target||a.srcElement;this.currentTarget=b;var d=a.relatedTarget;if(d){if(Ba){var e;a:{try{jc(d.nodeName);e=!0;break a}catch(g){}e=!1}e||(d=null)}}else"mouseover"==
c?d=a.fromElement:"mouseout"==c&&(d=a.toElement);this.relatedTarget=d;this.offsetX=z||void 0!==a.offsetX?a.offsetX:a.layerX;this.offsetY=z||void 0!==a.offsetY?a.offsetY:a.layerY;this.clientX=void 0!==a.clientX?a.clientX:a.pageX;this.clientY=void 0!==a.clientY?a.clientY:a.pageY;this.screenX=a.screenX||0;this.screenY=a.screenY||0;this.button=a.button;this.keyCode=a.keyCode||0;this.charCode=a.charCode||("keypress"==c?a.keyCode:0);this.ctrlKey=a.ctrlKey;this.altKey=a.altKey;this.shiftKey=a.shiftKey;this.metaKey=
a.metaKey;this.state=a.state;this.Db=a;a.defaultPrevented&&this.preventDefault();delete this.ga}}s(kc,Q);kc.prototype.preventDefault=function(){kc.pa.preventDefault.call(this);var a=this.Db;if(a.preventDefault)a.preventDefault();else if(a.returnValue=!1,ic)try{if(a.ctrlKey||112<=a.keyCode&&123>=a.keyCode)a.keyCode=-1}catch(b){}};kc.prototype.u=function(){};var lc="closure_lm_"+(1E6*Math.random()|0),mc={},nc=0;function oc(a,b,c,d,e){if(m(b)){for(var g=0;g<b.length;g++)oc(a,b[g],c,d,e);return null}c=pc(c);if(bc(a))a=a.Ra(b,c,d,e);else{if(!b)throw Error("Invalid event type");var g=!!d,h=qc(a);h||(a[lc]=h=new P(a));c=h.add(b,c,!1,d,e);c.Ua||(d=rc(),c.Ua=d,d.src=a,d.fa=c,a.addEventListener?a.addEventListener(b,d,g):a.attachEvent(b in mc?mc[b]:mc[b]="on"+b,d),nc++);a=c}return a}
function rc(){var a=sc,b=hc?function(c){return a.call(b.src,b.fa,c)}:function(c){c=a.call(b.src,b.fa,c);if(!c)return c};return b}function tc(a,b,c,d,e){if(m(b))for(var g=0;g<b.length;g++)tc(a,b[g],c,d,e);else c=pc(c),bc(a)?a.vb(b,c,d,e):a&&(a=qc(a))&&(b=a.ya(b,c,!!d,e))&&uc(b)}
function uc(a){if("number"==typeof a||!a||a.na)return!1;var b=a.src;if(bc(b))return gc(b.W,a);var c=a.type,d=a.Ua;b.removeEventListener?b.removeEventListener(c,d,a.capture):b.detachEvent&&b.detachEvent(c in mc?mc[c]:mc[c]="on"+c,d);nc--;(c=qc(b))?(gc(c,a),0==c.Ga&&(c.src=null,b[lc]=null)):ec(a);return!0}function vc(a,b,c,d){var e=1;if(a=qc(a))if(b=a.s[b])for(b=bb(b),a=0;a<b.length;a++){var g=b[a];g&&g.capture==c&&!g.na&&(e&=!1!==wc(g,d))}return Boolean(e)}
function wc(a,b){var c=a.fa,d=a.Oa||a.src;a.Ia&&uc(a);return c.call(d,b)}
function sc(a,b){if(a.na)return!0;if(!hc){var c=b||ba("window.event"),d=new kc(c,this),e=!0;if(!(0>c.keyCode||void 0!=c.returnValue)){a:{var g=!1;if(0==c.keyCode)try{c.keyCode=-1;break a}catch(h){g=!0}if(g||void 0==c.returnValue)c.returnValue=!0}c=[];for(g=d.currentTarget;g;g=g.parentNode)c.push(g);for(var g=a.type,k=c.length-1;!d.ga&&0<=k;k--)d.currentTarget=c[k],e&=vc(c[k],g,!0,d);for(k=0;!d.ga&&k<c.length;k++)d.currentTarget=c[k],e&=vc(c[k],g,!1,d)}return e}return wc(a,new kc(b,this))}
function qc(a){a=a[lc];return a instanceof P?a:null}var xc="__closure_events_fn_"+(1E9*Math.random()>>>0);function pc(a){return fa(a)?a:a[xc]||(a[xc]=function(b){return a.handleEvent(b)})};function R(){O.call(this);this.W=new P(this);this.fc=this}s(R,O);R.prototype[ac]=!0;f=R.prototype;f.tb=null;f.addEventListener=function(a,b,c,d){oc(this,a,b,c,d)};f.removeEventListener=function(a,b,c,d){tc(this,a,b,c,d)};
f.dispatchEvent=function(a){var b,c=this.tb;if(c)for(b=[];c;c=c.tb)b.push(c);var c=this.fc,d=a.type||a;if(n(a))a=new Q(a,c);else if(a instanceof Q)a.target=a.target||c;else{var e=a;a=new Q(d,c);Wa(a,e)}var e=!0,g;if(b)for(var h=b.length-1;!a.ga&&0<=h;h--)g=a.currentTarget=b[h],e=yc(g,d,!0,a)&&e;a.ga||(g=a.currentTarget=c,e=yc(g,d,!0,a)&&e,a.ga||(e=yc(g,d,!1,a)&&e));if(b)for(h=0;!a.ga&&h<b.length;h++)g=a.currentTarget=b[h],e=yc(g,d,!1,a)&&e;return e};
f.u=function(){R.pa.u.call(this);this.W&&this.W.Xa(void 0);this.tb=null};f.Ra=function(a,b,c,d){return this.W.add(String(a),b,!1,c,d)};f.vb=function(a,b,c,d){return this.W.remove(String(a),b,c,d)};function yc(a,b,c,d){b=a.W.s[String(b)];if(!b)return!0;b=bb(b);for(var e=!0,g=0;g<b.length;++g){var h=b[g];if(h&&!h.na&&h.capture==c){var k=h.fa,u=h.Oa||h.src;h.Ia&&gc(a.W,h);e=!1!==k.call(u,d)&&e}}return e&&!1!=d.Yb}f.ya=function(a,b,c,d){return this.W.ya(String(a),b,c,d)};function zc(a,b){R.call(this);this.ea=a||1;this.ra=b||l;this.ib=p(this.Gc,this);this.sb=q()}s(zc,R);f=zc.prototype;f.enabled=!1;f.l=null;f.setInterval=function(a){this.ea=a;this.l&&this.enabled?(this.stop(),this.start()):this.l&&this.stop()};f.Gc=function(){if(this.enabled){var a=q()-this.sb;0<a&&a<0.8*this.ea?this.l=this.ra.setTimeout(this.ib,this.ea-a):(this.l&&(this.ra.clearTimeout(this.l),this.l=null),this.dispatchEvent(Ac),this.enabled&&(this.l=this.ra.setTimeout(this.ib,this.ea),this.sb=q()))}};
f.start=function(){this.enabled=!0;this.l||(this.l=this.ra.setTimeout(this.ib,this.ea),this.sb=q())};f.stop=function(){this.enabled=!1;this.l&&(this.ra.clearTimeout(this.l),this.l=null)};f.u=function(){zc.pa.u.call(this);this.stop();delete this.ra};var Ac="tick";function Bc(a,b,c){if(fa(a))c&&(a=p(a,c));else if(a&&"function"==typeof a.handleEvent)a=p(a.handleEvent,a);else throw Error("Invalid listener argument");return 2147483647<b?-1:l.setTimeout(a,b||0)};function Cc(){}Cc.prototype.Ab=null;function Dc(a){var b;(b=a.Ab)||(b={},Ec(a)&&(b[0]=!0,b[1]=!0),b=a.Ab=b);return b};var Fc;function Gc(){}s(Gc,Cc);function Hc(a){return(a=Ec(a))?new ActiveXObject(a):new XMLHttpRequest}function Ec(a){if(!a.Kb&&"undefined"==typeof XMLHttpRequest&&"undefined"!=typeof ActiveXObject){for(var b=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"],c=0;c<b.length;c++){var d=b[c];try{return new ActiveXObject(d),a.Kb=d}catch(e){}}throw Error("Could not create ActiveXObject. ActiveX might be disabled, or MSXML might not be installed");}return a.Kb}Fc=new Gc;function Ic(a){R.call(this);this.headers=new cb;this.gb=a||null;this.T=!1;this.fb=this.f=null;this.Mb=this.Qa="";this.ka=0;this.q="";this.da=this.qb=this.Pa=this.nb=!1;this.Fa=0;this.bb=null;this.Xb=Jc;this.cb=this.dc=!1}s(Ic,R);var Jc="";Ic.prototype.r=Tb("goog.net.XhrIo");var Kc=/^https?$/i,Lc=["POST","PUT"];f=Ic.prototype;
f.send=function(a,b,c,d){if(this.f)throw Error("[goog.net.XhrIo] Object is active with another request="+this.Qa+"; newUri="+a);b=b?b.toUpperCase():"GET";this.Qa=a;this.q="";this.ka=0;this.Mb=b;this.nb=!1;this.T=!0;this.f=this.gb?Hc(this.gb):Hc(Fc);this.fb=this.gb?Dc(this.gb):Dc(Fc);this.f.onreadystatechange=p(this.Qb,this);try{M(this.r,S(this,"Opening Xhr")),this.qb=!0,this.f.open(b,a,!0),this.qb=!1}catch(e){M(this.r,S(this,"Error opening Xhr: "+e.message));Mc(this,e);return}a=c||"";var g=this.headers.n();
d&&D(d,function(a,b){g.set(b,a)});d=Za(g.ca());c=l.FormData&&a instanceof l.FormData;!(0<=Xa(Lc,b))||d||c||g.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");D(g,function(a,b){this.f.setRequestHeader(b,a)},this);this.Xb&&(this.f.responseType=this.Xb);"withCredentials"in this.f&&(this.f.withCredentials=this.dc);try{Nc(this),0<this.Fa&&(this.cb=Oc(this.f),M(this.r,S(this,"Will abort after "+this.Fa+"ms if incomplete, xhr2 "+this.cb)),this.cb?(this.f.timeout=this.Fa,this.f.ontimeout=
p(this.qa,this)):this.bb=Bc(this.qa,this.Fa,this)),M(this.r,S(this,"Sending request")),this.Pa=!0,this.f.send(a),this.Pa=!1}catch(h){M(this.r,S(this,"Send error: "+h.message)),Mc(this,h)}};function Oc(a){return y&&A(9)&&"number"==typeof a.timeout&&void 0!==a.ontimeout}function $a(a){return"content-type"==a.toLowerCase()}f.qa=function(){"undefined"!=typeof aa&&this.f&&(this.q="Timed out after "+this.Fa+"ms, aborting",this.ka=8,M(this.r,S(this,this.q)),this.dispatchEvent("timeout"),this.abort(8))};
function Mc(a,b){a.T=!1;a.f&&(a.da=!0,a.f.abort(),a.da=!1);a.q=b;a.ka=5;Pc(a);Qc(a)}function Pc(a){a.nb||(a.nb=!0,a.dispatchEvent("complete"),a.dispatchEvent("error"))}f.abort=function(a){this.f&&this.T&&(M(this.r,S(this,"Aborting")),this.T=!1,this.da=!0,this.f.abort(),this.da=!1,this.ka=a||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),Qc(this))};f.u=function(){this.f&&(this.T&&(this.T=!1,this.da=!0,this.f.abort(),this.da=!1),Qc(this,!0));Ic.pa.u.call(this)};
f.Qb=function(){this.mb||(this.qb||this.Pa||this.da?Rc(this):this.uc())};f.uc=function(){Rc(this)};
function Rc(a){if(a.T&&"undefined"!=typeof aa)if(a.fb[1]&&4==T(a)&&2==Sc(a))M(a.r,S(a,"Local request error detected and ignored"));else if(a.Pa&&4==T(a))Bc(a.Qb,0,a);else if(a.dispatchEvent("readystatechange"),4==T(a)){M(a.r,S(a,"Request complete"));a.T=!1;try{var b=Sc(a),c,d;a:switch(b){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:d=!0;break a;default:d=!1}if(!(c=d)){var e;if(e=0===b){var g=Ra(String(a.Qa))[1]||null;if(!g&&self.location)var h=self.location.protocol,g=h.substr(0,
h.length-1);e=!Kc.test(g?g.toLowerCase():"")}c=e}if(c)a.dispatchEvent("complete"),a.dispatchEvent("success");else{a.ka=6;var k;try{k=2<T(a)?a.f.statusText:""}catch(u){M(a.r,"Can not get status: "+u.message),k=""}a.q=k+" ["+Sc(a)+"]";Pc(a)}}finally{Qc(a)}}}function Qc(a,b){if(a.f){Nc(a);var c=a.f,d=a.fb[0]?ca:null;a.f=null;a.fb=null;b||a.dispatchEvent("ready");try{c.onreadystatechange=d}catch(e){(c=a.r)&&c.J("Problem encountered resetting onreadystatechange: "+e.message,void 0)}}}
function Nc(a){a.f&&a.cb&&(a.f.ontimeout=null);"number"==typeof a.bb&&(l.clearTimeout(a.bb),a.bb=null)}f.isActive=function(){return!!this.f};function T(a){return a.f?a.f.readyState:0}function Sc(a){try{return 2<T(a)?a.f.status:-1}catch(b){return(a=a.r)&&a.Z("Can not get status: "+b.message,void 0),-1}}function Tc(a){try{return a.f?a.f.responseText:""}catch(b){return M(a.r,"Can not get responseText: "+b.message),""}}f.Ib=function(){return n(this.q)?this.q:String(this.q)};
function S(a,b){return b+" ["+a.Mb+" "+a.Qa+" "+Sc(a)+"]"};function Uc(){this.Wb=q()}new Uc;Uc.prototype.set=function(a){this.Wb=a};Uc.prototype.reset=function(){this.set(q())};Uc.prototype.get=function(){return this.Wb};function Vc(a){O.call(this);this.e=a;this.j={}}s(Vc,O);var Wc=[];f=Vc.prototype;f.Ra=function(a,b,c,d){m(b)||(Wc[0]=b,b=Wc);for(var e=0;e<b.length;e++){var g=oc(a,b[e],c||this.handleEvent,d||!1,this.e||this);if(!g)break;this.j[g.key]=g}return this};f.vb=function(a,b,c,d,e){if(m(b))for(var g=0;g<b.length;g++)this.vb(a,b[g],c,d,e);else c=c||this.handleEvent,e=e||this.e||this,c=pc(c),d=!!d,b=bc(a)?a.ya(b,c,d,e):a?(a=qc(a))?a.ya(b,c,d,e):null:null,b&&(uc(b),delete this.j[b.key]);return this};
f.Xa=function(){var a=this.j,b=uc,c;for(c in a)b.call(void 0,a[c],c,a);this.j={}};f.u=function(){Vc.pa.u.call(this);this.Xa()};f.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented");};function Xc(a,b,c){O.call(this);this.pc=a;this.ea=b;this.e=c;this.jc=p(this.vc,this)}s(Xc,O);f=Xc.prototype;f.Za=!1;f.Vb=0;f.l=null;f.stop=function(){this.l&&(l.clearTimeout(this.l),this.l=null,this.Za=!1)};f.u=function(){Xc.pa.u.call(this);this.stop()};f.vc=function(){this.l=null;this.Za&&!this.Vb&&(this.Za=!1,Yc(this))};function Yc(a){a.l=Bc(a.jc,a.ea);a.pc.call(a.e)};function U(a,b,c,d,e){this.b=a;this.a=b;this.Y=c;this.B=d;this.Ea=e||1;this.qa=Zc;this.ob=new Vc(this);this.Ta=new zc;this.Ta.setInterval($c)}f=U.prototype;f.v=null;f.F=!1;f.ua=null;f.xb=null;f.Da=null;f.sa=null;f.U=null;f.w=null;f.X=null;f.k=null;f.Ha=0;f.K=null;f.ta=null;f.q=null;f.g=-1;f.Zb=!0;f.$=!1;f.ma=0;f.Va=null;var Zc=45E3,$c=250;
function ad(a,b){switch(a){case 0:return"Non-200 return code ("+b+")";case 1:return"XMLHTTP failure (no data)";case 2:return"HttpConnection timeout";default:return"Unknown error"}}var bd={},dd={};function ed(){return!y||y&&10<=Ma}f=U.prototype;f.S=function(a){this.v=a};f.setTimeout=function(a){this.qa=a};f.bc=function(a){this.ma=a};function fd(a,b,c){a.sa=1;a.U=H(b.n());a.X=c;a.Cb=!0;gd(a,null)}function hd(a,b,c,d,e){a.sa=1;a.U=H(b.n());a.X=null;a.Cb=c;e&&(a.Zb=!1);gd(a,d)}
function gd(a,b){a.Da=q();id(a);a.w=a.U.n();rb(a.w,"t",a.Ea);a.Ha=0;a.k=a.b.lb(a.b.$a()?b:null);0<a.ma&&(a.Va=new Xc(p(a.ec,a,a.k),a.ma));a.ob.Ra(a.k,"readystatechange",a.Bc);var c;if(a.v){c=a.v;var d={},e;for(e in c)d[e]=c[e];c=d}else c={};a.X?(a.ta="POST",c["Content-Type"]="application/x-www-form-urlencoded",a.k.send(a.w,a.ta,a.X,c)):(a.ta="GET",a.Zb&&!z&&(c.Connection="close"),a.k.send(a.w,a.ta,null,c));a.b.H(jd);if(d=a.X)for(c="",d=d.split("&"),e=0;e<d.length;e++){var g=d[e].split("=");if(1<g.length){var h=
g[0],g=g[1],k=h.split("_");c=2<=k.length&&"type"==k[1]?c+(h+"="+g+"&"):c+(h+"=redacted&")}}else c=null;a.a.info("XMLHTTP REQ ("+a.B+") [attempt "+a.Ea+"]: "+a.ta+"\n"+a.w+"\n"+c)}f.Bc=function(a){a=a.target;var b=this.Va;b&&3==T(a)?(this.a.debug("Throttling readystatechange."),b.l||b.Vb?b.Za=!0:Yc(b)):this.ec(a)};
f.ec=function(a){try{if(a==this.k)a:{var b=T(this.k),c=this.k.ka,d=Sc(this.k);if(!ed()||z&&!A("420+")){if(4>b)break a}else if(3>b||3==b&&!Aa&&!Tc(this.k))break a;this.$||4!=b||7==c||(8==c||0>=d?this.b.H(kd):this.b.H(ld));md(this);var e=Sc(this.k);this.g=e;var g=Tc(this.k);g||this.a.debug("No response text for uri "+this.w+" status "+e);this.F=200==e;this.a.info("XMLHTTP RESP ("+this.B+") [ attempt "+this.Ea+"]: "+this.ta+"\n"+this.w+"\n"+b+" "+e);this.F?(4==b&&V(this),this.Cb?(nd(this,b,g),Aa&&this.F&&
3==b&&(this.ob.Ra(this.Ta,Ac,this.Ac),this.Ta.start())):(Ub(this.a,this.B,g,null),od(this,g)),this.F&&!this.$&&(4==b?this.b.la(this):(this.F=!1,id(this)))):(400==e&&0<g.indexOf("Unknown SID")?(this.q=3,W(),this.a.Z("XMLHTTP Unknown SID ("+this.B+")")):(this.q=0,W(),this.a.Z("XMLHTTP Bad status "+e+" ("+this.B+")")),V(this),pd(this))}else this.a.Z("Called back with an unexpected xmlhttp")}catch(h){this.a.debug("Failed call to OnXmlHttpReadyStateChanged_"),this.k&&Tc(this.k)?Wb(this.a,h,"ResponseText: "+
Tc(this.k)):Wb(this.a,h,"No response text")}finally{}};function nd(a,b,c){for(var d=!0;!a.$&&a.Ha<c.length;){var e=qd(a,c);if(e==dd){4==b&&(a.q=4,W(),d=!1);Ub(a.a,a.B,null,"[Incomplete Response]");break}else if(e==bd){a.q=4;W();Ub(a.a,a.B,c,"[Invalid Chunk]");d=!1;break}else Ub(a.a,a.B,e,null),od(a,e)}4==b&&0==c.length&&(a.q=1,W(),d=!1);a.F=a.F&&d;d||(Ub(a.a,a.B,c,"[Invalid Chunked Response]"),V(a),pd(a))}
f.Ac=function(){var a=T(this.k),b=Tc(this.k);this.Ha<b.length&&(md(this),nd(this,a,b),this.F&&4!=a&&id(this))};function qd(a,b){var c=a.Ha,d=b.indexOf("\n",c);if(-1==d)return dd;c=Number(b.substring(c,d));if(isNaN(c))return bd;d+=1;if(d+c>b.length)return dd;var e=b.substr(d,c);a.Ha=d+c;return e}
function rd(a,b){a.Da=q();id(a);var c=b?window.location.hostname:"";a.w=a.U.n();G(a.w,"DOMAIN",c);G(a.w,"t",a.Ea);try{a.K=new ActiveXObject("htmlfile")}catch(d){a.a.J("ActiveX blocked");V(a);a.q=7;W();pd(a);return}var e="<html><body>";b&&(e+='<script>document.domain="'+c+'"\x3c/script>');e+="</body></html>";a.K.open();a.K.write(e);a.K.close();a.K.parentWindow.m=p(a.yc,a);a.K.parentWindow.d=p(a.Ub,a,!0);a.K.parentWindow.rpcClose=p(a.Ub,a,!1);c=a.K.createElement("div");a.K.parentWindow.document.body.appendChild(c);
c.innerHTML='<iframe src="'+a.w+'"></iframe>';a.a.info("TRIDENT REQ ("+a.B+") [ attempt "+a.Ea+"]: GET\n"+a.w);a.b.H(jd)}f.yc=function(a){Y(p(this.xc,this,a),0)};f.xc=function(a){if(!this.$){var b=this.a;b.info("TRIDENT TEXT ("+this.B+"): "+Vb(b,a));md(this);od(this,a);id(this)}};f.Ub=function(a){Y(p(this.wc,this,a),0)};f.wc=function(a){this.$||(this.a.info("TRIDENT TEXT ("+this.B+"): "+a?"success":"failure"),V(this),this.F=a,this.b.la(this),this.b.H(sd))};f.nc=function(){md(this);this.b.la(this)};
f.cancel=function(){this.$=!0;V(this)};function id(a){a.xb=q()+a.qa;td(a,a.qa)}function td(a,b){if(null!=a.ua)throw Error("WatchDog timer not null");a.ua=Y(p(a.zc,a),b)}function md(a){a.ua&&(l.clearTimeout(a.ua),a.ua=null)}
f.zc=function(){this.ua=null;var a=q();0<=a-this.xb?(this.F&&this.a.J("Received watchdog timeout even though request loaded successfully"),this.a.info("TIMEOUT: "+this.w),2!=this.sa&&this.b.H(kd),V(this),this.q=2,W(),pd(this)):(this.a.Z("WatchDog timer called too early"),td(this,this.xb-a))};function pd(a){a.b.Lb()||a.$||a.b.la(a)}function V(a){md(a);var b=a.Va;b&&"function"==typeof b.Ja&&b.Ja();a.Va=null;a.Ta.stop();a.ob.Xa();a.k&&(b=a.k,a.k=null,b.abort(),b.Ja());a.K&&(a.K=null)}f.Ib=function(){return this.q};
function od(a,b){try{a.b.Rb(a,b),a.b.H(sd)}catch(c){Wb(a.a,c,"Error in httprequest callback")}};function ud(a,b,c,d,e){(new N).debug("TestLoadImageWithRetries: "+e);if(0==d)c(!1);else{var g=e||0;d--;vd(a,b,function(e){e?c(!0):l.setTimeout(function(){ud(a,b,c,d,g)},g)})}}
function vd(a,b,c){function d(a,b){return function(){try{e.debug("TestLoadImage: "+b),g.onload=null,g.onerror=null,g.onabort=null,g.ontimeout=null,l.clearTimeout(h),c(a)}catch(d){Wb(e,d)}}}var e=new N;e.debug("TestLoadImage: loading "+a);var g=new Image,h=null;g.onload=d(!0,"loaded");g.onerror=d(!1,"error");g.onabort=d(!1,"abort");g.ontimeout=d(!1,"timeout");h=l.setTimeout(function(){if(g.ontimeout)g.ontimeout()},b);g.src=a};function wd(a,b){this.b=a;this.a=b;this.P=new Yb(0,!0)}f=wd.prototype;f.v=null;f.A=null;f.Wa=!1;f.cc=null;f.La=null;f.rb=null;f.I=null;f.c=null;f.g=-1;f.L=null;f.va=null;f.S=function(a){this.v=a};f.ac=function(a){this.P=a};
f.kb=function(a){this.I=a;a=xd(this.b,this.I);W();this.cc=q();var b=this.b.Gb;null!=b?(this.L=this.b.correctHostPrefix(b[0]),(this.va=b[1])?(this.c=1,yd(this)):(this.c=2,zd(this))):(rb(a,"MODE","init"),this.A=new U(this,this.a,void 0,void 0,void 0),this.A.S(this.v),hd(this.A,a,!1,null,!0),this.c=0)};function yd(a){var b=Ad(a.b,a.va,"/mail/images/cleardot.gif");H(b);ud(b.toString(),5E3,p(a.kc,a),3,2E3);a.H(jd)}
f.kc=function(a){if(a)this.c=2,zd(this);else{W();var b=this.b;b.a.debug("Test Connection Blocked");b.g=b.V.g;Z(b,9)}a&&this.H(ld)};
function zd(a){a.a.debug("TestConnection: starting stage 2");var b=a.b.Dc;if(null!=b)a.a.debug("TestConnection: skipping stage 2, precomputed result is "+b?"Buffered":"Unbuffered"),W(),b?(W(),Bd(a.b,a,!1)):(W(),Bd(a.b,a,!0));else if(a.A=new U(a,a.a,void 0,void 0,void 0),a.A.S(a.v),b=Cd(a.b,a.L,a.I),W(),ed())rb(b,"TYPE","xmlhttp"),hd(a.A,b,!1,a.L,!1);else{rb(b,"TYPE","html");var c=a.A;a=Boolean(a.L);c.sa=3;c.U=H(b.n());rd(c,a)}}f.lb=function(a){return this.b.lb(a)};
f.abort=function(){this.A&&(this.A.cancel(),this.A=null);this.g=-1};f.Lb=function(){return!1};
f.Rb=function(a,b){this.g=a.g;if(0==this.c)if(this.a.debug("TestConnection: Got data for stage 1"),b){try{var c=this.P.parse(b)}catch(d){Wb(this.a,d);Dd(this.b,this);return}this.L=this.b.correctHostPrefix(c[0]);this.va=c[1]}else this.a.debug("TestConnection: Null responseText"),Dd(this.b,this);else if(2==this.c)if(this.Wa)W(),this.rb=q();else if("11111"==b){if(W(),this.Wa=!0,this.La=q(),c=this.La-this.cc,ed()||500>c)this.g=200,this.A.cancel(),this.a.debug("Test connection succeeded; using streaming connection"),
W(),Bd(this.b,this,!0)}else W(),this.La=this.rb=q(),this.Wa=!1};
f.la=function(){this.g=this.A.g;if(!this.A.F)this.a.debug("TestConnection: request failed, in state "+this.c),0==this.c?W():2==this.c&&W(),Dd(this.b,this);else if(0==this.c)this.a.debug("TestConnection: request complete for initial check"),this.va?(this.c=1,yd(this)):(this.c=2,zd(this));else if(2==this.c){this.a.debug("TestConnection: request complete for stage 2");var a=!1;(a=ed()?this.Wa:200>this.rb-this.La?!1:!0)?(this.a.debug("Test connection succeeded; using streaming connection"),W(),Bd(this.b,
this,!0)):(this.a.debug("Test connection failed; not using streaming"),W(),Bd(this.b,this,!1))}};f.$a=function(){return this.b.$a()};f.isActive=function(){return this.b.isActive()};f.H=function(a){this.b.H(a)};function Ed(a,b,c){this.Bb=a||null;this.c=Fd;this.t=[];this.Q=[];this.a=new N;this.P=new Yb(0,!0);this.Gb=b||null;this.Dc=null!=c?c:null}function Gd(a,b){this.Ob=a;this.map=b}f=Ed.prototype;f.v=null;f.xa=null;f.p=null;f.i=null;f.I=null;f.Ma=null;f.zb=null;f.L=null;f.hc=!0;f.Ba=0;f.sc=0;f.Ka=!1;f.e=null;f.G=null;f.M=null;f.aa=null;f.V=null;f.wb=null;f.gc=!0;f.za=-1;f.Nb=-1;f.g=-1;f.ba=0;f.ha=0;f.ic=5E3;f.Cc=1E4;f.pb=2;f.Hb=48E4;f.ma=0;f.ab=!1;f.ia=8;var Fd=1,Hd=new R;
function Id(a){Q.call(this,"statevent",a)}s(Id,Q);function Jd(a,b){Q.call(this,"timingevent",a);this.size=b}s(Jd,Q);var jd=1,ld=2,kd=3,sd=4;function Kd(a){Q.call(this,"serverreachability",a)}s(Kd,Q);var Xb="y2f%";f=Ed.prototype;f.kb=function(a,b,c,d,e){this.a.debug("connect()");W();this.I=b;this.xa=c||{};d&&void 0!==e&&(this.xa.OSID=d,this.xa.OAID=e);this.a.debug("connectTest_()");Ld(this)&&(this.V=new wd(this,this.a),this.V.S(this.v),this.V.ac(this.P),this.V.kb(a))};
f.disconnect=function(){this.a.debug("disconnect()");Md(this);if(3==this.c){var a=this.Ba++,b=this.Ma.n();G(b,"SID",this.Y);G(b,"RID",a);G(b,"TYPE","terminate");Nd(this,b);a=new U(this,this.a,this.Y,a,void 0);a.sa=2;a.U=H(b.n());b=new Image;b.src=a.U;b.onload=b.onerror=p(a.nc,a);a.Da=q();id(a)}Od(this)};function Md(a){a.V&&(a.V.abort(),a.V=null);a.i&&(a.i.cancel(),a.i=null);a.M&&(l.clearTimeout(a.M),a.M=null);Pd(a);a.p&&(a.p.cancel(),a.p=null);a.G&&(l.clearTimeout(a.G),a.G=null)}
f.S=function(a){this.v=a};f.bc=function(a){this.ma=a};f.Lb=function(){return 0==this.c};f.ac=function(a){this.P=a};function Qd(a){a.p||a.G||(a.G=Y(p(a.Tb,a),0),a.ba=0)}
f.Tb=function(a){this.G=null;this.a.debug("startForwardChannel_");if(Ld(this))if(this.c==Fd)if(a)this.a.J("Not supposed to retry the open");else{this.a.debug("open_()");this.Ba=Math.floor(1E5*Math.random());a=this.Ba++;var b=new U(this,this.a,"",a,void 0);b.S(this.v);var c=Rd(this),d=this.Ma.n();G(d,"RID",a);this.Bb&&G(d,"CVER",this.Bb);Nd(this,d);fd(b,d,c);this.p=b;this.c=2}else 3==this.c&&(a?Sd(this,a):0==this.t.length?this.a.debug("startForwardChannel_ returned: nothing to send"):this.p?this.a.J("startForwardChannel_ returned: connection already in progress"):
(Sd(this),this.a.debug("startForwardChannel_ finished, sent request")))};function Sd(a,b){var c,d;b?6<a.ia?(a.t=a.Q.concat(a.t),a.Q.length=0,c=a.Ba-1,d=Rd(a)):(c=b.B,d=b.X):(c=a.Ba++,d=Rd(a));var e=a.Ma.n();G(e,"SID",a.Y);G(e,"RID",c);G(e,"AID",a.za);Nd(a,e);c=new U(a,a.a,a.Y,c,a.ba+1);c.S(a.v);c.setTimeout(Math.round(0.5*a.Hb)+Math.round(0.5*a.Hb*Math.random()));a.p=c;fd(c,e,d)}function Nd(a,b){if(a.e){var c=a.e.getAdditionalParams(a);c&&D(c,function(a,c){G(b,c,a)})}}
function Rd(a){var b=Math.min(a.t.length,1E3),c=["count="+b],d;6<a.ia&&0<b?(d=a.t[0].Ob,c.push("ofs="+d)):d=0;for(var e=0;e<b;e++){var g=a.t[e].Ob,h=a.t[e].map,g=6>=a.ia?e:g-d;try{D(h,function(a,b){c.push("req"+g+"_"+b+"="+encodeURIComponent(a))})}catch(k){c.push("req"+g+"_type="+encodeURIComponent("_badmap")),a.e&&a.e.badMapError(a,h)}}a.Q=a.Q.concat(a.t.splice(0,b));return c.join("&")}function Td(a){a.i||a.M||(a.yb=1,a.M=Y(p(a.Sb,a),0),a.ha=0)}
function Ud(a){if(a.i||a.M)return a.a.J("Request already in progress"),!1;if(3<=a.ha)return!1;a.a.debug("Going to retry GET");a.yb++;a.M=Y(p(a.Sb,a),Vd(a,a.ha));a.ha++;return!0}
f.Sb=function(){this.M=null;if(Ld(this)){this.a.debug("Creating new HttpRequest");this.i=new U(this,this.a,this.Y,"rpc",this.yb);this.i.S(this.v);this.i.bc(this.ma);var a=this.zb.n();G(a,"RID","rpc");G(a,"SID",this.Y);G(a,"CI",this.wb?"0":"1");G(a,"AID",this.za);Nd(this,a);if(ed())G(a,"TYPE","xmlhttp"),hd(this.i,a,!0,this.L,!1);else{G(a,"TYPE","html");var b=this.i,c=Boolean(this.L);b.sa=3;b.U=H(a.n());rd(b,c)}this.a.debug("New Request created")}};
function Ld(a){if(a.e){var b=a.e.okToMakeRequest(a);if(0!=b)return a.a.debug("Handler returned error code from okToMakeRequest"),Z(a,b),!1}return!0}function Bd(a,b,c){a.a.debug("Test Connection Finished");a.wb=a.gc&&c;a.g=b.g;a.a.debug("connectChannel_()");a.lc(Fd,0);a.Ma=xd(a,a.I);Qd(a)}function Dd(a,b){a.a.debug("Test Connection Failed");a.g=b.g;Z(a,2)}
f.Rb=function(a,b){if(0!=this.c&&(this.i==a||this.p==a))if(this.g=a.g,this.p==a&&3==this.c)if(7<this.ia){var c;try{c=this.P.parse(b)}catch(d){c=null}if(m(c)&&3==c.length){var e=c;if(0==e[0])a:if(this.a.debug("Server claims our backchannel is missing."),this.M)this.a.debug("But we are currently starting the request.");else{if(this.i)if(this.i.Da+3E3<this.p.Da)Pd(this),this.i.cancel(),this.i=null;else break a;else this.a.Z("We do not have a BackChannel established");Ud(this);W()}else this.Nb=e[1],c=
this.Nb-this.za,0<c&&(e=e[2],this.a.debug(e+" bytes (in "+c+" arrays) are outstanding on the BackChannel"),37500>e&&this.wb&&0==this.ha&&!this.aa&&(this.aa=Y(p(this.tc,this),6E3)))}else this.a.debug("Bad POST response data returned"),Z(this,11)}else b!=Xb&&(this.a.debug("Bad data returned - missing/invald magic cookie"),Z(this,11));else if(this.i==a&&Pd(this),!/^[\s\xa0]*$/.test(b)){c=this.P.parse(b);for(var e=this.e&&this.e.channelHandleMultipleArrays?[]:null,g=0;g<c.length;g++){var h=c[g];this.za=
h[0];h=h[1];2==this.c?"c"==h[0]?(this.Y=h[1],this.L=this.correctHostPrefix(h[2]),h=h[3],this.ia=null!=h?h:6,this.c=3,this.e&&this.e.channelOpened(this),this.zb=Cd(this,this.L,this.I),Td(this)):"stop"==h[0]&&Z(this,7):3==this.c&&("stop"==h[0]?(e&&0!=e.length&&(this.e.channelHandleMultipleArrays(this,e),e.length=0),Z(this,7)):"noop"!=h[0]&&(e?e.push(h):this.e&&this.e.channelHandleArray(this,h)),this.ha=0)}e&&0!=e.length&&this.e.channelHandleMultipleArrays(this,e)}};
f.correctHostPrefix=function(a){return this.hc?this.e?this.e.correctHostPrefix(a):a:null};f.tc=function(){null!=this.aa&&(this.aa=null,this.i.cancel(),this.i=null,Ud(this),W())};function Pd(a){null!=a.aa&&(l.clearTimeout(a.aa),a.aa=null)}
f.la=function(a){this.a.debug("Request complete");var b;if(this.i==a)Pd(this),this.i=null,b=2;else if(this.p==a)this.p=null,b=1;else return;this.g=a.g;if(0!=this.c)if(a.F)1==b?(q(),Hd.dispatchEvent(new Jd(Hd,a.X?a.X.length:0)),Qd(this),this.Q.length=0):Td(this);else{var c=a.Ib();if(3==c||7==c||0==c&&0<this.g)this.a.debug("Not retrying due to error type");else{this.a.debug("Maybe retrying, last error: "+ad(c,this.g));var d;if(d=1==b)this.p||this.G?(this.a.J("Request already in progress"),d=!1):this.c==
Fd||this.ba>=(this.Ka?0:this.pb)?d=!1:(this.a.debug("Going to retry POST"),this.G=Y(p(this.Tb,this,a),Vd(this,this.ba)),this.ba++,d=!0);if(d||2==b&&Ud(this))return;this.a.debug("Exceeded max number of retries")}this.a.debug("Error: HTTP request failed");switch(c){case 1:Z(this,5);break;case 4:Z(this,10);break;case 3:Z(this,6);break;case 7:Z(this,12);break;default:Z(this,2)}}};function Vd(a,b){var c=a.ic+Math.floor(Math.random()*a.Cc);a.isActive()||(a.a.debug("Inactive channel"),c*=2);return c*b}
f.lc=function(a){if(!(0<=Xa(arguments,this.c)))throw Error("Unexpected channel state: "+this.c);};function Z(a,b){a.a.info("Error code "+b);if(2==b||9==b){var c=null;a.e&&(c=a.e.getNetworkTestImageUri(a));var d=p(a.Fc,a);c||(c=new E("//www.google.com/images/cleardot.gif"),H(c));vd(c.toString(),1E4,d)}else W();Wd(a,b)}f.Fc=function(a){a?(this.a.info("Successfully pinged google.com"),W()):(this.a.info("Failed to ping google.com"),W(),Wd(this,8))};
function Wd(a,b){a.a.debug("HttpChannel: error - "+b);a.c=0;a.e&&a.e.channelError(a,b);Od(a);Md(a)}function Od(a){a.c=0;a.g=-1;if(a.e)if(0==a.Q.length&&0==a.t.length)a.e.channelClosed(a);else{a.a.debug("Number of undelivered maps, pending: "+a.Q.length+", outgoing: "+a.t.length);var b=bb(a.Q),c=bb(a.t);a.Q.length=0;a.t.length=0;a.e.channelClosed(a,b,c)}}function xd(a,b){var c=Ad(a,null,b);a.a.debug("GetForwardChannelUri: "+c);return c}
function Cd(a,b,c){b=Ad(a,a.$a()?b:null,c);a.a.debug("GetBackChannelUri: "+b);return b}function Ad(a,b,c){var d=tb(c);if(""!=d.ja)b&&gb(d,b+"."+d.ja),hb(d,d.Ca);else var e=window.location,d=ub(e.protocol,b?b+"."+e.hostname:e.hostname,e.port,c);a.xa&&D(a.xa,function(a,b){G(d,b,a)});G(d,"VER",a.ia);Nd(a,d);return d}f.lb=function(a){if(a&&!this.ab)throw Error("Can't create secondary domain capable XhrIo object.");a=new Ic;a.dc=this.ab;return a};f.isActive=function(){return!!this.e&&this.e.isActive(this)};
function Y(a,b){if(!fa(a))throw Error("Fn must not be null and must be a function");return l.setTimeout(function(){a()},b)}f.H=function(){Hd.dispatchEvent(new Kd(Hd))};function W(){Hd.dispatchEvent(new Id(Hd))}f.$a=function(){return this.ab||!ed()};function Xd(){}f=Xd.prototype;f.channelHandleMultipleArrays=null;f.okToMakeRequest=function(){return 0};f.channelOpened=function(){};f.channelHandleArray=function(){};f.channelError=function(){};f.channelClosed=function(){};f.getAdditionalParams=function(){return{}};
f.getNetworkTestImageUri=function(){return null};f.isActive=function(){return!0};f.badMapError=function(){};f.correctHostPrefix=function(a){return a};var $,Yd;Yd={0:"Ok",4:"User is logging out",6:"Unknown session ID",7:"Stopped by server",8:"General network error",2:"Request failed",9:"Blocked by a network administrator",5:"No data from server",10:"Got bad data from the server",11:"Got a bad response from the server"};
$=function(a,b){var c,d,e,g,h,k,u,K,v,r,Ka,w,X,cd;if(!(this instanceof $))return new $(a,b);r=this;a||(a="channel");a.match(/:\/\//)&&a.replace(/^ws/,"http");b||(b={});m(b||"string"===typeof b)&&(b={});K=b.reconnectTime||3E3;c=b.extraHeaders||null;d=b.extraParams||null;null!==b.affinity&&(d||(d={}),b.affinityParam||(b.affinityParam="a"),this.affinity=b.affinity||sa(),d[b.affinityParam]=this.affinity);X=function(a){r.readyState=r.readyState=a};X(this.CLOSED);w=null;k=null!=(cd=b.prev)?cd.Ec:void 0;
e=function(a,b,c,d,e){try{return"function"===typeof r[a]?r[a](c,d,e):void 0}catch(g){throw"undefined"!==typeof console&&null!==console&&console.error(g.stack),g;}};g=new Xd;g.channelOpened=function(){k=w;X($.OPEN);return e("onopen")};h=null;g.channelError=function(a,b){var c;c=Yd[b];h=b;r.readyState!==$.CLOSED&&X($.hb);return e("onerror",0,c,b)};v=null;g.channelClosed=function(a,c,d){var g;if(r.readyState!==$.CLOSED)return w=null,a=h?Yd[h]:"Closed",X($.CLOSED),b.reconnect&&7!==h&&0!==h&&(g=6===h?
0:K,clearTimeout(v),v=setTimeout(u,g)),e("onclose",0,a,c,d),h=null};g.channelHandleArray=function(a,b){return e("onmessage",0,{type:"message",data:b})};u=function(){if(w)throw Error("Reconnect() called from invalid state");X($.CONNECTING);e("onconnecting");clearTimeout(v);r.Ec=w=new Ed(b.appVersion,null!=k?k.Gb:void 0);b.crossDomainXhr&&(w.ab=!0);w.e=g;c&&w.S(c);h=null;if(b.failFast){var t=w;t.Ka=!0;t.a.info("setFailFast: true");(t.p||t.G)&&t.ba>(t.Ka?0:t.pb)&&(t.a.info("Retry count "+t.ba+" > new maxRetries "+
(t.Ka?0:t.pb)+". Fail immediately!"),t.p?(t.p.cancel(),t.la(t.p)):(l.clearTimeout(t.G),t.G=null,Z(t,2)))}return w.kb(""+a+"/test",""+a+"/bind",d,null!=k?k.Y:void 0,null!=k?k.za:void 0)};this.open=function(){if(r.readyState!==r.CLOSED)throw Error("Already open");return u()};this.close=function(){clearTimeout(v);h=0;if(r.readyState!==$.CLOSED)return X($.hb),w.disconnect()};this.sendMap=Ka=function(a){var b;if((b=r.readyState)!==$.hb&&b!==$.CLOSED){b=w;if(0==b.c)throw Error("Invalid operation: sending map when state is closed");
1E3==b.t.length&&b.a.J("Already have 1000 queued maps upon queueing "+yb(a));b.t.push(new Gd(b.sc++,a));2!=b.c&&3!=b.c||Qd(b)}};this.send=function(a){return"string"===typeof a?Ka({_S:a}):Ka({JSON:yb(a)})};u()};$.prototype.canSendWhileConnecting=$.canSendWhileConnecting=!0;$.prototype.canSendJSON=$.canSendJSON=!0;$.prototype.CONNECTING=$.CONNECTING=$.CONNECTING=0;$.prototype.OPEN=$.OPEN=$.OPEN=1;$.prototype.CLOSING=$.CLOSING=$.hb=2;$.prototype.CLOSED=$.CLOSED=$.CLOSED=3;
("undefined"!==typeof exports&&null!==exports?exports:window).BCSocket=$;
})();!function(){function e(e){e.t="text0";var n={p:e.p.pop()};null!=e.si&&(n.i=e.si),null!=e.sd&&(n.d=e.sd),e.o=[n]}function n(e){e.p.push(e.o[0].p),null!=e.o[0].i&&(e.si=e.o[0].i),null!=e.o[0].d&&(e.sd=e.o[0].d),delete e.t,delete e.o}var i={exports:{}},t=i.exports;t._bootstrapTransform=function(e,n,i,t){var r=function(e,i,t,r){n(t,e,i,"left"),n(r,i,e,"right")},l=e.transformX=function(e,n){i(e),i(n);for(var o=[],p=0;p<n.length;p++){for(var d=n[p],f=[],s=0;s<e.length;){var a=[];if(r(e[s],d,f,a),s++,1!==a.length){if(0===a.length){for(var u=s;u<e.length;u++)t(f,e[u]);d=null;break}for(var v=l(e.slice(s),a),h=0;h<v[0].length;h++)t(f,v[0][h]);for(var c=0;c<v[1].length;c++)t(o,v[1][c]);d=null;break}d=a[0]}null!=d&&t(o,d),e=f}return[e,o]};e.transform=e.transform=function(e,i,t){if("left"!==t&&"right"!==t)throw Error("type must be 'left' or 'right'");return 0===i.length?e:1===e.length&&1===i.length?n([],e[0],i[0],t):"left"===t?l(e,i)[0]:l(i,e)[1]}};var r=i.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(e){if(null!=e&&"string"!=typeof e)throw Error("Initial data must be a string");return e||""}},l=function(e,n,i){return e.slice(0,n)+i+e.slice(n)},o=function(e){if("number"!=typeof e.p)throw Error("component missing position field");if("string"==typeof e.i==("string"==typeof e.d))throw Error("component needs an i or d field");if(e.p<0)throw Error("position cannot be negative")},p=function(e){for(var n=0;n<e.length;n++)o(e[n])};r.apply=function(e,n){var i;p(n);for(var t=0;t<n.length;t++){var r=n[t];if(null!=r.i)e=l(e,r.p,r.i);else{if(i=e.slice(r.p,r.p+r.d.length),r.d!==i)throw Error("Delete component '"+r.d+"' does not match deleted text '"+i+"'");e=e.slice(0,r.p)+e.slice(r.p+r.d.length)}}return e};var d=r._append=function(e,n){if(""!==n.i&&""!==n.d)if(0===e.length)e.push(n);else{var i=e[e.length-1];null!=i.i&&null!=n.i&&i.p<=n.p&&n.p<=i.p+i.i.length?e[e.length-1]={i:l(i.i,n.p-i.p,n.i),p:i.p}:null!=i.d&&null!=n.d&&n.p<=i.p&&i.p<=n.p+n.d.length?e[e.length-1]={d:l(n.d,i.p-n.p,i.d),p:n.p}:e.push(n)}};r.compose=function(e,n){p(e),p(n);for(var i=e.slice(),t=0;t<n.length;t++)d(i,n[t]);return i},r.normalize=function(e){var n=[];(null!=e.i||null!=e.p)&&(e=[e]);for(var i=0;i<e.length;i++){var t=e[i];null==t.p&&(t.p=0),d(n,t)}return n};var f=function(e,n,i){return null!=n.i?n.p<e||n.p===e&&i?e+n.i.length:e:e<=n.p?e:e<=n.p+n.d.length?n.p:e-n.d.length};r.transformCursor=function(e,n,i){for(var t="right"===i,r=0;r<n.length;r++)e=f(e,n[r],t);return e};var s=r._tc=function(e,n,i,t){if(o(n),o(i),null!=n.i)d(e,{i:n.i,p:f(n.p,i,"right"===t)});else if(null!=i.i){var r=n.d;n.p<i.p&&(d(e,{d:r.slice(0,i.p-n.p),p:n.p}),r=r.slice(i.p-n.p)),""!==r&&d(e,{d:r,p:n.p+i.i.length})}else if(n.p>=i.p+i.d.length)d(e,{d:n.d,p:n.p-i.d.length});else if(n.p+n.d.length<=i.p)d(e,n);else{var l={d:"",p:n.p};n.p<i.p&&(l.d=n.d.slice(0,i.p-n.p)),n.p+n.d.length>i.p+i.d.length&&(l.d+=n.d.slice(i.p+i.d.length-n.p));var p=Math.max(n.p,i.p),s=Math.min(n.p+n.d.length,i.p+i.d.length),a=n.d.slice(p-n.p,s-n.p),u=i.d.slice(p-i.p,s-i.p);if(a!==u)throw Error("Delete ops delete different text in the same region of the document");""!==l.d&&(l.p=f(l.p,i),d(e,l))}return e},a=function(e){return null!=e.i?{d:e.i,p:e.p}:{i:e.d,p:e.p}};r.invert=function(e){e=e.slice().reverse();for(var n=0;n<e.length;n++)e[n]=a(e[n]);return e},t._bootstrapTransform?t._bootstrapTransform(r,s,p,d):require("./helpers")._bootstrapTransform(r,s,p,d);var u=function(e){return"[object Array]"==Object.prototype.toString.call(e)},v=function(e){return!!e&&e.constructor===Object},h=function(e){return JSON.parse(JSON.stringify(e))},c={name:"json0",uri:"http://sharejs.org/types/JSONv0"},g={};c.registerSubtype=function(e){g[e.name]=e},c.create=function(e){return void 0===e?null:h(e)},c.invertComponent=function(e){var n={p:e.p};return e.t&&g[e.t]&&(n.t=e.t,n.o=g[e.t].invert(e.o)),void 0!==e.si&&(n.sd=e.si),void 0!==e.sd&&(n.si=e.sd),void 0!==e.oi&&(n.od=e.oi),void 0!==e.od&&(n.oi=e.od),void 0!==e.li&&(n.ld=e.li),void 0!==e.ld&&(n.li=e.ld),void 0!==e.na&&(n.na=-e.na),void 0!==e.lm&&(n.lm=e.p[e.p.length-1],n.p=e.p.slice(0,e.p.length-1).concat([e.lm])),n},c.invert=function(e){for(var n=e.slice().reverse(),i=[],t=0;t<n.length;t++)i.push(c.invertComponent(n[t]));return i},c.checkValidOp=function(e){for(var n=0;n<e.length;n++)if(!u(e[n].p))throw Error("Missing path")},c.checkList=function(e){if(!u(e))throw Error("Referenced element not a list")},c.checkObj=function(e){if(!v(e))throw Error("Referenced element not an object (it was "+JSON.stringify(e)+")")},c.apply=function(n,i){c.checkValidOp(i),i=h(i);for(var t={data:n},r=0;r<i.length;r++){var l=i[r];(null!=l.si||null!=l.sd)&&e(l);for(var o=null,p=null,d=t,f="data",s=0;s<l.p.length;s++){var a=l.p[s];if(o=d,p=f,d=d[f],f=a,null==o)throw Error("Path invalid")}if(l.t&&void 0!==l.o&&g[l.t])d[f]=g[l.t].apply(d[f],l.o);else if(void 0!==l.na){if("number"!=typeof d[f])throw Error("Referenced element not a number");d[f]+=l.na}else if(void 0!==l.li&&void 0!==l.ld)c.checkList(d),d[f]=l.li;else if(void 0!==l.li)c.checkList(d),d.splice(f,0,l.li);else if(void 0!==l.ld)c.checkList(d),d.splice(f,1);else if(void 0!==l.lm){if(c.checkList(d),l.lm!=f){var u=d[f];d.splice(f,1),d.splice(l.lm,0,u)}}else if(void 0!==l.oi)c.checkObj(d),d[f]=l.oi;else{if(void 0===l.od)throw Error("invalid / missing instruction in op");c.checkObj(d),delete d[f]}}return t.data},c.shatter=function(e){for(var n=[],i=0;i<e.length;i++)n.push([e[i]]);return n},c.incrementalApply=function(e,n,i){for(var t=0;t<n.length;t++){var r=[n[t]];e=c.apply(e,r),i(r,e)}return e};var m=c.pathMatches=function(e,n,i){if(e.length!=n.length)return!1;for(var t=0;t<e.length;t++)if(e[t]!==n[t]&&(!i||t!==e.length-1))return!1;return!0};if(c.append=function(i,t){if(t=h(t),0===i.length)return void i.push(t);var r=i[i.length-1];if(null==t.si&&null==t.sd||null==r.si&&null==r.sd||(e(t),e(r)),m(t.p,r.p))if(t.t&&r.t&&t.t===r.t&&g[t.t]){if(r.o=g[t.t].compose(r.o,t.o),null!=t.si||null!=t.sd){for(var l=t.p,o=0;o<r.o.length-1;o++)t.o=[r.o.pop()],t.p=l.slice(),n(t),i.push(t);n(r)}}else null!=r.na&&null!=t.na?i[i.length-1]={p:r.p,na:r.na+t.na}:void 0!==r.li&&void 0===t.li&&t.ld===r.li?void 0!==r.ld?delete r.li:i.pop():void 0!==r.od&&void 0===r.oi&&void 0!==t.oi&&void 0===t.od?r.oi=t.oi:void 0!==r.oi&&void 0!==t.od?void 0!==t.oi?r.oi=t.oi:void 0!==r.od?delete r.oi:i.pop():void 0!==t.lm&&t.p[t.p.length-1]===t.lm||i.push(t);else null==t.si&&null==t.sd||null==r.si&&null==r.sd||(n(t),n(r)),i.push(t)},c.compose=function(e,n){c.checkValidOp(e),c.checkValidOp(n);for(var i=h(e),t=0;t<n.length;t++)c.append(i,n[t]);return i},c.normalize=function(e){var n=[];e=u(e)?e:[e];for(var i=0;i<e.length;i++){var t=e[i];null==t.p&&(t.p=[]),c.append(n,t)}return n},c.commonLengthForOps=function(e,n){var i=e.p.length,t=n.p.length;if((null!=e.na||e.t)&&i++,(null!=n.na||n.t)&&t++,0===i)return-1;if(0===t)return null;i--,t--;for(var r=0;i>r;r++){var l=e.p[r];if(r>=t||l!==n.p[r])return null}return i},c.canOpAffectPath=function(e,n){return null!=c.commonLengthForOps({p:n},e)},c.transformComponent=function(i,t,r,l){t=h(t);var o=c.commonLengthForOps(r,t),p=c.commonLengthForOps(t,r),d=t.p.length,f=r.p.length;if((null!=t.na||t.t)&&d++,(null!=r.na||r.t)&&f++,null!=p&&f>d&&t.p[p]==r.p[p])if(void 0!==t.ld){var s=h(r);s.p=s.p.slice(d),t.ld=c.apply(h(t.ld),[s])}else if(void 0!==t.od){var s=h(r);s.p=s.p.slice(d),t.od=c.apply(h(t.od),[s])}if(null!=o){var a=d==f,s=r;if(null==t.si&&null==t.sd||null==r.si&&null==r.sd||(e(t),s=h(r),e(s)),s.t&&g[s.t]){if(t.t&&t.t===s.t){var u=g[t.t].transform(t.o,s.o,l);if(u.length>0)if(null!=t.si||null!=t.sd)for(var v=t.p,m=0;m<u.length;m++)t.o=[u[m]],t.p=v.slice(),n(t),c.append(i,t);else t.o=u,c.append(i,t);return i}}else if(void 0!==r.na);else if(void 0!==r.li&&void 0!==r.ld){if(r.p[o]===t.p[o]){if(!a)return i;if(void 0!==t.ld){if(void 0===t.li||"left"!==l)return i;t.ld=h(r.li)}}}else if(void 0!==r.li)void 0!==t.li&&void 0===t.ld&&a&&t.p[o]===r.p[o]?"right"===l&&t.p[o]++:r.p[o]<=t.p[o]&&t.p[o]++,void 0!==t.lm&&a&&r.p[o]<=t.lm&&t.lm++;else if(void 0!==r.ld){if(void 0!==t.lm&&a){if(r.p[o]===t.p[o])return i;var v=r.p[o],y=t.p[o],b=t.lm;(b>v||v===b&&b>y)&&t.lm--}if(r.p[o]<t.p[o])t.p[o]--;else if(r.p[o]===t.p[o]){if(d>f)return i;if(void 0!==t.ld){if(void 0===t.li)return i;delete t.ld}}}else if(void 0!==r.lm)if(void 0!==t.lm&&d===f){var y=t.p[o],b=t.lm,w=r.p[o],O=r.lm;if(w!==O)if(y===w){if("left"!==l)return i;t.p[o]=O,y===b&&(t.lm=O)}else y>w&&t.p[o]--,y>O?t.p[o]++:y===O&&w>O&&(t.p[o]++,y===b&&t.lm++),b>w?t.lm--:b===w&&b>y&&t.lm--,b>O?t.lm++:b===O&&(O>w&&b>y||w>O&&y>b?"right"===l&&t.lm++:b>y?t.lm++:b===w&&t.lm--)}else if(void 0!==t.li&&void 0===t.ld&&a){var y=r.p[o],b=r.lm;v=t.p[o],v>y&&t.p[o]--,v>b&&t.p[o]++}else{var y=r.p[o],b=r.lm;v=t.p[o],v===y?t.p[o]=b:(v>y&&t.p[o]--,v>b?t.p[o]++:v===b&&y>b&&t.p[o]++)}else if(void 0!==r.oi&&void 0!==r.od){if(t.p[o]===r.p[o]){if(void 0===t.oi||!a)return i;if("right"===l)return i;t.od=r.oi}}else if(void 0!==r.oi){if(void 0!==t.oi&&t.p[o]===r.p[o]){if("left"!==l)return i;c.append(i,{p:t.p,od:r.oi})}}else if(void 0!==r.od&&t.p[o]==r.p[o]){if(!a)return i;if(void 0===t.oi)return i;delete t.od}}return c.append(i,t),i},t._bootstrapTransform?t._bootstrapTransform(c,c.transformComponent,c.checkValidOp,c.append):require("./helpers")._bootstrapTransform(c,c.transformComponent,c.checkValidOp,c.append),void 0===r)var r="undefined"!=typeof require?require("./text0"):window.ottypes.text;c.registerSubtype(r),i.exports=c;var y=window.ottypes=window.ottypes||{},b=i.exports;y[b.name]=b,b.uri&&(y[b.uri]=b)}();!function(){function t(t){for(var e in t)return!0;return!1}!function(){var t={exports:{}},e=t.exports;e.name="text",e.uri="http://sharejs.org/types/textv1",e.create=function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""};var n=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},i=function(t){if(!n(t))throw Error("Op must be an array of components");for(var e=null,i=0;t.length>i;i++){var o=t[i];switch(typeof o){case"object":if(!("number"==typeof o.d&&o.d>0))throw Error("Object components must be deletes of size > 0");break;case"string":if(!(o.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(o>0))throw Error("Skip components must be >0");if("number"==typeof e)throw Error("Adjacent skip components should be combined")}e=o}if("number"==typeof e)throw Error("Op has a trailing skip")},o=function(t){return function(e){return e&&0!==e.d?0===t.length?t.push(e):typeof e==typeof t[t.length-1]?"object"==typeof e?t[t.length-1].d+=e.d:t[t.length-1]+=e:t.push(e):void 0}},r=function(t){var e=0,n=0,i=function(i,o){if(e===t.length)return-1===i?null:i;var r,s=t[e];return"number"==typeof s?-1===i||i>=s-n?(r=s-n,++e,n=0,r):(n+=i,i):"string"==typeof s?-1===i||"i"===o||i>=s.length-n?(r=s.slice(n),++e,n=0,r):(r=s.slice(n,n+i),n+=i,r):-1===i||"d"===o||i>=s.d-n?(r={d:s.d-n},++e,n=0,r):(n+=i,{d:i})},o=function(){return t[e]};return[i,o]},s=function(t){return"number"==typeof t?t:t.length||t.d},a=function(t){return t.length>0&&"number"==typeof t[t.length-1]&&t.pop(),t};e.normalize=function(t){for(var e=[],n=o(e),i=0;t.length>i;i++)n(t[i]);return a(e)},e.apply=function(t,e){if("string"!=typeof t)throw Error("Snapshot should be a string");i(e);for(var n=[],o=0;e.length>o;o++){var r=e[o];switch(typeof r){case"number":if(r>t.length)throw Error("The op is too long for this document");n.push(t.slice(0,r)),t=t.slice(r);break;case"string":n.push(r);break;case"object":t=t.slice(r.d)}}return n.join("")+t},e.transform=function(t,e,n){if("left"!=n&&"right"!=n)throw Error("side ("+n+") must be 'left' or 'right'");i(t),i(e);for(var c=[],h=o(c),l=r(t),p=l[0],u=l[1],f=0;e.length>f;f++){var d,v,g=e[f];switch(typeof g){case"number":for(d=g;d>0;)v=p(d,"i"),h(v),"string"!=typeof v&&(d-=s(v));break;case"string":"left"===n&&"string"==typeof u()&&h(p(-1)),h(g.length);break;case"object":for(d=g.d;d>0;)switch(v=p(d,"i"),typeof v){case"number":d-=v;break;case"string":h(v);break;case"object":d-=v.d}}}for(;g=p(-1);)h(g);return a(c)},e.compose=function(t,e){i(t),i(e);for(var n=[],c=o(n),h=r(t)[0],l=0;e.length>l;l++){var p,u,f=e[l];switch(typeof f){case"number":for(p=f;p>0;)u=h(p,"d"),c(u),"object"!=typeof u&&(p-=s(u));break;case"string":c(f);break;case"object":for(p=f.d;p>0;)switch(u=h(p,"d"),typeof u){case"number":c({d:u}),p-=u;break;case"string":p-=u.length;break;case"object":c(u)}}}for(;f=h(-1);)c(f);return a(n)};var c=function(t,e){for(var n=0,i=0;e.length>i;i++){var o=e[i];if(n>=t)break;switch(typeof o){case"number":if(n+o>=t)return t;n+=o;break;case"string":n+=o.length,t+=o.length;break;case"object":t-=Math.min(o.d,t-n)}}return t};e.transformSelection=function(t,e,n){var i=0;if(n){for(var o=0;e.length>o;o++){var r=e[o];switch(typeof r){case"number":i+=r;break;case"string":i+=r.length}}return i}return"number"==typeof t?c(t,e):[c(t[0],e),c(t[1],e)]},e.transformCursor=e.transformSelection,e.selectionEq=function(t,e){return null!=t[0]&&t[0]===t[1]&&(t=t[0]),null!=e[0]&&e[0]===e[1]&&(e=e[0]),t===e||null!=t[0]&&null!=e[0]&&t[0]===e[0]&&t[1]==e[1]};var h=window.ottypes=window.ottypes||{},l=t.exports;h[l.name]=l,l.uri&&(h[l.uri]=l)}();var e="undefined"!=typeof require?require("ottypes"):window.ottypes;e["http://sharejs.org/types/textv1"].api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},get:function(){return this.getSnapshot()},getText:function(){return console.warn("`getText()` is deprecated; use `get()` instead."),this.get()},insert:function(t,e,n){return this.submitOp([t,e],n)},remove:function(t,e,n){return this.submitOp([t,{d:e}],n)},_onOp:function(t){for(var e=0,n=0,i=0;i<t.length;i++){var o=t[i];switch(typeof o){case"number":e+=o,n+=o;break;case"string":this.onInsert&&this.onInsert(e,o),e+=o.length;break;case"object":this.onRemove&&this.onRemove(e,o.d),n+=o.d}}}},!function(){function t(t){t.t="text0";var e={p:t.p.pop()};null!=t.si&&(e.i=t.si),null!=t.sd&&(e.d=t.sd),t.o=[e]}function e(t){t.p.push(t.o[0].p),null!=t.o[0].i&&(t.si=t.o[0].i),null!=t.o[0].d&&(t.sd=t.o[0].d),delete t.t,delete t.o}var n={exports:{}},i=n.exports;i._bootstrapTransform=function(t,e,n,i){var o=function(t,n,i,o){e(i,t,n,"left"),e(o,n,t,"right")},r=t.transformX=function(t,e){n(t),n(e);for(var s=[],a=0;a<e.length;a++){for(var c=e[a],h=[],l=0;l<t.length;){var p=[];if(o(t[l],c,h,p),l++,1!==p.length){if(0===p.length){for(var u=l;u<t.length;u++)i(h,t[u]);c=null;break}for(var f=r(t.slice(l),p),d=0;d<f[0].length;d++)i(h,f[0][d]);for(var v=0;v<f[1].length;v++)i(s,f[1][v]);c=null;break}c=p[0]}null!=c&&i(s,c),t=h}return[t,s]};t.transform=t.transform=function(t,n,i){if("left"!==i&&"right"!==i)throw Error("type must be 'left' or 'right'");return 0===n.length?t:1===t.length&&1===n.length?e([],t[0],n[0],i):"left"===i?r(t,n)[0]:r(n,t)[1]}};var o=n.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""}},r=function(t,e,n){return t.slice(0,e)+n+t.slice(e)},s=function(t){if("number"!=typeof t.p)throw Error("component missing position field");if("string"==typeof t.i==("string"==typeof t.d))throw Error("component needs an i or d field");if(t.p<0)throw Error("position cannot be negative")},a=function(t){for(var e=0;e<t.length;e++)s(t[e])};o.apply=function(t,e){var n;a(e);for(var i=0;i<e.length;i++){var o=e[i];if(null!=o.i)t=r(t,o.p,o.i);else{if(n=t.slice(o.p,o.p+o.d.length),o.d!==n)throw Error("Delete component '"+o.d+"' does not match deleted text '"+n+"'");t=t.slice(0,o.p)+t.slice(o.p+o.d.length)}}return t};var c=o._append=function(t,e){if(""!==e.i&&""!==e.d)if(0===t.length)t.push(e);else{var n=t[t.length-1];null!=n.i&&null!=e.i&&n.p<=e.p&&e.p<=n.p+n.i.length?t[t.length-1]={i:r(n.i,e.p-n.p,e.i),p:n.p}:null!=n.d&&null!=e.d&&e.p<=n.p&&n.p<=e.p+e.d.length?t[t.length-1]={d:r(e.d,n.p-e.p,n.d),p:e.p}:t.push(e)}};o.compose=function(t,e){a(t),a(e);for(var n=t.slice(),i=0;i<e.length;i++)c(n,e[i]);return n},o.normalize=function(t){var e=[];(null!=t.i||null!=t.p)&&(t=[t]);for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=0),c(e,i)}return e};var h=function(t,e,n){return null!=e.i?e.p<t||e.p===t&&n?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length};o.transformCursor=function(t,e,n){for(var i="right"===n,o=0;o<e.length;o++)t=h(t,e[o],i);return t};var l=o._tc=function(t,e,n,i){if(s(e),s(n),null!=e.i)c(t,{i:e.i,p:h(e.p,n,"right"===i)});else if(null!=n.i){var o=e.d;e.p<n.p&&(c(t,{d:o.slice(0,n.p-e.p),p:e.p}),o=o.slice(n.p-e.p)),""!==o&&c(t,{d:o,p:e.p+n.i.length})}else if(e.p>=n.p+n.d.length)c(t,{d:e.d,p:e.p-n.d.length});else if(e.p+e.d.length<=n.p)c(t,e);else{var r={d:"",p:e.p};e.p<n.p&&(r.d=e.d.slice(0,n.p-e.p)),e.p+e.d.length>n.p+n.d.length&&(r.d+=e.d.slice(n.p+n.d.length-e.p));var a=Math.max(e.p,n.p),l=Math.min(e.p+e.d.length,n.p+n.d.length),p=e.d.slice(a-e.p,l-e.p),u=n.d.slice(a-n.p,l-n.p);if(p!==u)throw Error("Delete ops delete different text in the same region of the document");""!==r.d&&(r.p=h(r.p,n),c(t,r))}return t},p=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}};o.invert=function(t){t=t.slice().reverse();for(var e=0;e<t.length;e++)t[e]=p(t[e]);return t},i._bootstrapTransform?i._bootstrapTransform(o,l,a,c):require("./helpers")._bootstrapTransform(o,l,a,c);var u=function(t){return"[object Array]"==Object.prototype.toString.call(t)},f=function(t){return!!t&&t.constructor===Object},d=function(t){return JSON.parse(JSON.stringify(t))},v={name:"json0",uri:"http://sharejs.org/types/JSONv0"},g={};v.registerSubtype=function(t){g[t.name]=t},v.create=function(t){return void 0===t?null:d(t)},v.invertComponent=function(t){var e={p:t.p};return t.t&&g[t.t]&&(e.t=t.t,e.o=g[t.t].invert(t.o)),void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},v.invert=function(t){for(var e=t.slice().reverse(),n=[],i=0;i<e.length;i++)n.push(v.invertComponent(e[i]));return n},v.checkValidOp=function(t){for(var e=0;e<t.length;e++)if(!u(t[e].p))throw Error("Missing path")},v.checkList=function(t){if(!u(t))throw Error("Referenced element not a list")},v.checkObj=function(t){if(!f(t))throw Error("Referenced element not an object (it was "+JSON.stringify(t)+")")},v.apply=function(e,n){v.checkValidOp(n),n=d(n);for(var i={data:e},o=0;o<n.length;o++){var r=n[o];(null!=r.si||null!=r.sd)&&t(r);for(var s=null,a=null,c=i,h="data",l=0;l<r.p.length;l++){var p=r.p[l];if(s=c,a=h,c=c[h],h=p,null==s)throw Error("Path invalid")}if(r.t&&void 0!==r.o&&g[r.t])c[h]=g[r.t].apply(c[h],r.o);else if(void 0!==r.na){if("number"!=typeof c[h])throw Error("Referenced element not a number");c[h]+=r.na}else if(void 0!==r.li&&void 0!==r.ld)v.checkList(c),c[h]=r.li;else if(void 0!==r.li)v.checkList(c),c.splice(h,0,r.li);else if(void 0!==r.ld)v.checkList(c),c.splice(h,1);else if(void 0!==r.lm){if(v.checkList(c),r.lm!=h){var u=c[h];c.splice(h,1),c.splice(r.lm,0,u)}}else if(void 0!==r.oi)v.checkObj(c),c[h]=r.oi;else{if(void 0===r.od)throw Error("invalid / missing instruction in op");v.checkObj(c),delete c[h]}}return i.data},v.shatter=function(t){for(var e=[],n=0;n<t.length;n++)e.push([t[n]]);return e},v.incrementalApply=function(t,e,n){for(var i=0;i<e.length;i++){var o=[e[i]];t=v.apply(t,o),n(o,t)}return t};var y=v.pathMatches=function(t,e,n){if(t.length!=e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]!==e[i]&&(!n||i!==t.length-1))return!1;return!0};if(v.append=function(n,i){if(i=d(i),0===n.length)return void n.push(i);var o=n[n.length-1];if(null==i.si&&null==i.sd||null==o.si&&null==o.sd||(t(i),t(o)),y(i.p,o.p))if(i.t&&o.t&&i.t===o.t&&g[i.t]){if(o.o=g[i.t].compose(o.o,i.o),null!=i.si||null!=i.sd){for(var r=i.p,s=0;s<o.o.length-1;s++)i.o=[o.o.pop()],i.p=r.slice(),e(i),n.push(i);e(o)}}else null!=o.na&&null!=i.na?n[n.length-1]={p:o.p,na:o.na+i.na}:void 0!==o.li&&void 0===i.li&&i.ld===o.li?void 0!==o.ld?delete o.li:n.pop():void 0!==o.od&&void 0===o.oi&&void 0!==i.oi&&void 0===i.od?o.oi=i.oi:void 0!==o.oi&&void 0!==i.od?void 0!==i.oi?o.oi=i.oi:void 0!==o.od?delete o.oi:n.pop():void 0!==i.lm&&i.p[i.p.length-1]===i.lm||n.push(i);else null==i.si&&null==i.sd||null==o.si&&null==o.sd||(e(i),e(o)),n.push(i)},v.compose=function(t,e){v.checkValidOp(t),v.checkValidOp(e);for(var n=t,i=0;i<e.length;i++)v.append(n,e[i]);return n},v.normalize=function(t){var e=[];t=u(t)?t:[t];for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=[]),v.append(e,i)}return e},v.commonLengthForOps=function(t,e){var n=t.p.length,i=e.p.length;if((null!=t.na||t.t)&&n++,(null!=e.na||e.t)&&i++,0===n)return-1;if(0===i)return null;n--,i--;for(var o=0;n>o;o++){var r=t.p[o];if(o>=i||r!==e.p[o])return null}return n},v.canOpAffectPath=function(t,e){return null!=v.commonLengthForOps({p:e},t)},v.transformComponent=function(n,i,o,r){i=d(i);var s=v.commonLengthForOps(o,i),a=v.commonLengthForOps(i,o),c=i.p.length,h=o.p.length;if((null!=i.na||i.t)&&c++,(null!=o.na||o.t)&&h++,null!=a&&h>c&&i.p[a]==o.p[a])if(void 0!==i.ld){var l=d(o);l.p=l.p.slice(c),i.ld=v.apply(d(i.ld),[l])}else if(void 0!==i.od){var l=d(o);l.p=l.p.slice(c),i.od=v.apply(d(i.od),[l])}if(null!=s){var p=c==h,l=o;if(null==i.si&&null==i.sd||null==o.si&&null==o.sd||(t(i),l=d(o),t(l)),l.t&&g[l.t]){if(i.t&&i.t===l.t){var u=g[i.t].transform(i.o,l.o,r);if(u.length>0)if(null!=i.si||null!=i.sd)for(var f=i.p,y=0;y<u.length;y++)i.o=[u[y]],i.p=f.slice(),e(i),v.append(n,i);else i.o=u,v.append(n,i);return n}}else if(void 0!==o.na);else if(void 0!==o.li&&void 0!==o.ld){if(o.p[s]===i.p[s]){if(!p)return n;if(void 0!==i.ld){if(void 0===i.li||"left"!==r)return n;i.ld=d(o.li)}}}else if(void 0!==o.li)void 0!==i.li&&void 0===i.ld&&p&&i.p[s]===o.p[s]?"right"===r&&i.p[s]++:o.p[s]<=i.p[s]&&i.p[s]++,void 0!==i.lm&&p&&o.p[s]<=i.lm&&i.lm++;else if(void 0!==o.ld){if(void 0!==i.lm&&p){if(o.p[s]===i.p[s])return n;var f=o.p[s],b=i.p[s],m=i.lm;(m>f||f===m&&m>b)&&i.lm--}if(o.p[s]<i.p[s])i.p[s]--;else if(o.p[s]===i.p[s]){if(c>h)return n;if(void 0!==i.ld){if(void 0===i.li)return n;delete i.ld}}}else if(void 0!==o.lm)if(void 0!==i.lm&&c===h){var b=i.p[s],m=i.lm,_=o.p[s],w=o.lm;if(_!==w)if(b===_){if("left"!==r)return n;i.p[s]=w,b===m&&(i.lm=w)}else b>_&&i.p[s]--,b>w?i.p[s]++:b===w&&_>w&&(i.p[s]++,b===m&&i.lm++),m>_?i.lm--:m===_&&m>b&&i.lm--,m>w?i.lm++:m===w&&(w>_&&m>b||_>w&&b>m?"right"===r&&i.lm++:m>b?i.lm++:m===_&&i.lm--)}else if(void 0!==i.li&&void 0===i.ld&&p){var b=o.p[s],m=o.lm;f=i.p[s],f>b&&i.p[s]--,f>m&&i.p[s]++}else{var b=o.p[s],m=o.lm;f=i.p[s],f===b?i.p[s]=m:(f>b&&i.p[s]--,f>m?i.p[s]++:f===m&&b>m&&i.p[s]++)}else if(void 0!==o.oi&&void 0!==o.od){if(i.p[s]===o.p[s]){if(void 0===i.oi||!p)return n;if("right"===r)return n;i.od=o.oi}}else if(void 0!==o.oi){if(void 0!==i.oi&&i.p[s]===o.p[s]){if("left"!==r)return n;v.append(n,{p:i.p,od:o.oi})}}else if(void 0!==o.od&&i.p[s]==o.p[s]){if(!p)return n;if(void 0===i.oi)return n;delete i.od}}return v.append(n,i),n},i._bootstrapTransform?i._bootstrapTransform(v,v.transformComponent,v.checkValidOp,v.append):require("./helpers")._bootstrapTransform(v,v.transformComponent,v.checkValidOp,v.append),void 0===o)var o="undefined"!=typeof require?require("./text0"):window.ottypes.text;v.registerSubtype(o),n.exports=v;var b=window.ottypes=window.ottypes||{},m=n.exports;b[m.name]=m,m.uri&&(b[m.uri]=m)}(),function(){function t(t){return 1===t.length&&t[0].constructor===Array?t[0]:t}function e(t,e){for(var n="data",i={data:t},o=0;o<e.length;o++)if(i=i[n],n=e[o],"undefined"==typeof i)throw new Error("bad path");return{elem:i,key:n}}function n(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0}function i(t,e){return!(t.length<e.length)&&n(t.slice(0,e.length),e)}function o(){}function r(t){return t instanceof Array?t:"number"==typeof t?[t]:void 0}function s(t,e,n,i){e=Array.prototype.slice.call(e);var s=t.path||[];return n.length>1&&"function"!=typeof e[e.length-1]&&e.push(o),e.length<(i||n.length)?e.unshift(s):e[0]=s.concat(r(e[0])),n.apply(t,e)}var a=[].slice,c="undefined"!=typeof require?require("ottypes"):window.ottypes,h=c["http://sharejs.org/types/JSONv0"],l=function(t,e){this.context=t,this.path=e||[]};l.prototype._updatePath=function(t){console.log("UPDATEPATH",t);for(var e=0;e<t.length;e++){var n=t[e];if(void 0!==n.lm&&i(this.path,n.p)){var o=n.p.slice(0,n.p.length-1);o.push(n.lm),this.path=o.concat(this.path.slice(o.length))}}},l.prototype.createContextAt=function(){var e=1<=arguments.length?a.call(arguments,0):[];return this.context.createContextAt(this.path.concat(t(e)))},l.prototype.get=function(t){return s(this,arguments,function(t){return this.context.get(t)})},l.prototype.set=function(t,e,n){return s(this,arguments,function(t,e,n){return this.context.set(t,e,n)})},l.prototype.insert=function(t,e,n){return s(this,arguments,function(t,e,n){return this.context.insert(t,e,n)})},l.prototype.remove=function(t,e,n){return s(this,arguments,function(t,e,n){return this.context.remove(t,e,n)},2)},l.prototype.push=function(t,n,i){return s(this,arguments,function(t,n,i){var o=e(this.context.getSnapshot(),t),r=o.elem[o.key].length;return t.push(r),this.context.insert(t,n,i)})},l.prototype.move=function(t,e,n,i){return s(this,arguments,function(t,e,n,i){return console.log("sd MOVE"),this.context.move(t,e,n,i)})},l.prototype.add=function(t,e,n){return s(this,arguments,function(t,e,n){return this.context.add(t,e,n)})},l.prototype.on=function(t,e){return this.context.addListener(this.path,t,e)},l.prototype.removeListener=function(t){return this.context.removeListener(t)},l.prototype.getLength=function(t){return s(this,arguments,function(t){return this.context.getLength(t)})},l.prototype.getText=function(t){return s(this,arguments,function(t){return this.context.getText(t)})},l.prototype.deleteText=function(t,e,n,i){return s(this,arguments,function(t,e,n,i){return this.context.deleteText(t,n,e,i)})},l.prototype.destroy=function(){this.context._removeSubDoc(this)},h.api={provides:{json:!0},_fixComponentPaths:function(t){if(this._listeners&&void 0===t.na&&void 0===t.si&&void 0===t.sd){for(var e=[],n=this._listeners,i=0;i<n.length;i++){var o=n[i],r={p:o.path,na:0},s=h.transformComponent([],r,t,"left");if(0===s.length)e.push(i);else{if(1!==s.length)throw new Error("Bad assumption in json-api: xforming an 'na' op will always result in 0 or 1 components.");o.path=s[0].p}}e.sort(function(t,e){return e-t});for(var a=[],c=0;c<e.length;c++)i=e[c],a.push(this._listeners.splice(i,1));return a}},_fixPaths:function(t){for(var e=[],n=0;n<t.length;n++){var i=t[n];e.push(this._fixComponentPaths(i))}return e},_submit:function(t,e){return this._fixPaths(t),this.submitOp(t,e)},_addSubDoc:function(t){this._subdocs||(this._subdocs=[]),this._subdocs.push(t)},_removeSubDoc:function(t){this._subdocs||(this._subdocs=[]);for(var e=0;e<this._subdocs.length;e++)return void(this._subdocs[e]===t&&this._subdocs.splice(e,1))},_updateSubdocPaths:function(t){this._subdocs||(this._subdocs=[]);for(var e=0;e<this._subdocs.length;e++)this._subdocs[e]._updatePath(t)},createContextAt:function(){var e=1<=arguments.length?a.call(arguments,0):[],n=new l(this,t(e));return this._addSubDoc(n),n},get:function(t){return t?s(this,arguments,function(t){var n=e(this.getSnapshot(),t);return n.elem[n.key]}):this.getSnapshot()},set:function(t,n,i){return s(this,arguments,function(t,n,i){var o=e(this.getSnapshot(),t),r=o.elem,s=o.key,a={p:t};if(r.constructor===Array)a.li=n,"undefined"!=typeof r[s]&&(a.ld=r[s]);else{if("object"!=typeof r)throw new Error("bad path");a.oi=n,"undefined"!=typeof r[s]&&(a.od=r[s])}return this._submit([a],i)})},remove:function(t,n,i){return s(this,arguments,function(t,n,i){!i&&n instanceof Function&&(i=n,n=null);var o,r,s,a;if(null===n||void 0===n){if(o=e(this.getSnapshot(),t),r=o.elem,a=o.key,s={p:t},"undefined"==typeof r[a])throw new Error("no element at that path");if(r.constructor===Array)s.ld=r[a];else{if("object"!=typeof r)throw new Error("bad path");s.od=r[a]}return this._submit([s],i)}var c;if(c=t.pop(),o=e(this.getSnapshot(),t),r=o.elem,a=o.key,"string"==typeof r[a])return s={p:t.concat(c),sd:o.elem[o.key].slice(c,c+n)},this._submit([s],i);if(r[a].constructor===Array){for(var h=[],l=c;l<c+n;l++)h.push({p:t.concat(c),ld:r[a][l]});return this._submit(h,i)}throw new Error("element at path does not support range")},2)},insert:function(t,n,i){return s(this,arguments,function(t,n,i){var o=t.pop(),r=e(this.getSnapshot(),t),s=r.elem,a=r.key,c={p:t.concat(o)};return s[a].constructor===Array?c.li=n:"string"==typeof s[a]&&(c.si=n),this._submit([c],i)})},move:function(t,e,n,i){return s(this,arguments,function(t,e,n,i){var o=this,r=[{p:t.concat(e),lm:n}];return this._submit(r,function(){o._updateSubdocPaths(r),i&&i.apply(i,arguments)})})},push:function(t,n,i){return s(this,arguments,function(t,n,i){var o=e(this.getSnapshot(),t),r=o.elem[o.key].length;return t.push(r),this.insert(t,n,i)})},add:function(t,e,n){return s(this,arguments,function(t,n,i){var o=[{p:t,na:e}];return this._submit(o,i)})},getLength:function(t){return s(this,arguments,function(t){return this.get(t).length})},getText:function(t){return s(this,arguments,function(t){return console.warn("Deprecated. Use `get()` instead"),this.get(t)})},deleteText:function(t,n,i,o){return s(this,arguments,function(t,n,i,o){console.warn("Deprecated. Use `remove(path, length, cb)` instead");var r=e(this.getSnapshot(),t),s=[{p:t.concat(i),sd:r.elem[r.key].slice(i,i+n)}];return this._submit(s,o)})},addListener:function(t,e,n){return s(this,arguments,function(t,n,i){var o={path:t,event:e,cb:i};return this._listeners||(this._listeners=[]),this._listeners.push(o),o})},removeListener:function(t){if(this._listeners){var e=this._listeners.indexOf(t);return!(e<0)&&(this._listeners.splice(e,1),!0)}},_onOp:function(t){for(var e=0;e<t.length;e++){var i=t[e];this._fixComponentPaths(i),void 0!==i.lm&&this._updateSubdocPaths([i]);for(var o=void 0===i.na?i.p.slice(0,i.p.length-1):i.p,r=0;r<this._listeners.length;r++){var s=this._listeners[r],a=s.cb;if(n(s.path,o))switch(s.event){case"insert":void 0!==i.li&&void 0===i.ld?a(i.p[i.p.length-1],i.li):void 0!==i.oi&&void 0===i.od?a(i.p[i.p.length-1],i.oi):void 0!==i.si&&a(i.p[i.p.length-1],i.si);break;case"delete":void 0===i.li&&void 0!==i.ld?a(i.p[i.p.length-1],i.ld):void 0===i.oi&&void 0!==i.od?a(i.p[i.p.length-1],i.od):void 0!==i.sd&&a(i.p[i.p.length-1],i.sd);break;case"replace":void 0!==i.li&&void 0!==i.ld?a(i.p[i.p.length-1],i.ld,i.li):void 0!==i.oi&&void 0!==i.od&&a(i.p[i.p.length-1],i.od,i.oi);break;case"move":void 0!==i.lm&&a(i.p[i.p.length-1],i.lm);break;case"add":void 0!==i.na&&a(i.na)}if(h.canOpAffectPath(i,s.path)&&"child op"===s.event){var c=i.p.slice(s.path.length);a(c,i)}}}}}}.call(this);var n=window.collab_service={version:"0.9.0"},i=function(){};i.prototype.on=function(t,e){var n=this._events=this._events||{};(n[t]=n[t]||[]).push(e)},i.prototype.removeListener=function(t,e){for(var n=this._events=this._events||{},i=n[t]=n[t]||[],o=0;o<i.length;)i[o]===e&&(i[o]=void 0),o++;setTimeout(function(){n[t]=[];for(var e,o=0;o<i.length;o++)(e=i[o])&&n[t].push(e)},0)},i.prototype.emit=function(t){var e=this._events,n=Array.prototype.splice.call(arguments,1);if(!e||!e[t])return void("error"==t&&console&&console.error.apply(console,n));for(var i=e[t],o=0;o<i.length;o++)i[o]&&i[o].apply(this,n)},i.prototype.once=function(t,e){var n,i=this;this.on(t,n=function(){i.removeListener(t,n),e.apply(i,arguments)})},i.mixin=function(t){var e=t.prototype||t;return e.on=i.prototype.on,e.removeListener=i.prototype.removeListener,e.emit=i.prototype.emit,e.once=i.prototype.once,t},"undefined"!=typeof module&&(module.exports=i);var o;o="undefined"!=typeof require?require("ottypes"):window.ottypes,n.registerType=function(t){t.name&&(o[t.name]=t),t.uri&&(o[t.uri]=t)};var o,i;"undefined"!=typeof require?(o=require("ottypes"),i=require("./microevent")):o=window.ottypes;var r=n.Doc=function(t,e,n){this.connection=t,this.collection=e,this.name=n,this.version=this.type=null,this.snapshot=void 0,this.action=null,this.state=null,this.subscribed=!1,this.wantSubscribe=!1,this._subscribeCallbacks=[],this.provides={},this.editingContexts=[],this.inflightData=null,this.pendingData=[],this.type=null};i.mixin(r),r.prototype.destroy=function(t){var e=this;this.unsubscribe(function(){e.hasPending()?e.once("nothing pending",function(){e.connection._destroyDoc(e)}):e.connection._destroyDoc(e),e.removeContexts(),t&&t()})},r.prototype._setType=function(t){if("string"==typeof t){if(!o[t])throw new Error("Missing type "+t+" "+this.collection+" "+this.name);t=o[t]}this.removeContexts(),this.type=t,t?t.api&&(this.provides=t.api.provides):(this.provides={},this.snapshot=void 0)},r.prototype.ingestData=function(t){if("number"!=typeof t.v)throw new Error("Missing version in ingested data "+this.collection+" "+this.name);if(this.state){if(this.version>=t.v)return;return void console.warn("Ignoring ingest data for",this.collection,this.name,"\n  in state:",this.state,"\n  version:",this.version,"\n  snapshot:\n",this.snapshot,"\n  incoming data:\n",t)}this.version=t.v,this.snapshot=t.data,this._setType(t.type),this.state="ready",this.emit("ready")},r.prototype.getSnapshot=function(){return this.snapshot},r.prototype.whenReady=function(t){"ready"===this.state?t():this.once("ready",t)},r.prototype.retry=function(){if(this.inflightData){var t=5e3*Math.pow(2,this.inflightData.retries);this.inflightData.sentAt<Date.now()-t&&(this.connection.emit("retry",this),this._clearAction())}},r.prototype.hasPending=function(){return null!=this.action||null!=this.inflightData||!!this.pendingData.length},r.prototype.numberPending=function(){return(null!=this.inflightData?1:0)+(this.pendingData?this.pendingData.length:0)},r.prototype._handleTypedError=function(t){if(t&&"string"==typeof t&&t.length>=7&&"json://"===t.substring(0,7)){var e=t.substring(7),n=JSON.parse(e);this.emit("typedError",n)}else this.emit("error",t)},r.prototype._send=function(t){t.c=this.collection,t.d=this.name,this.connection.send(t)},r.prototype._handleSubscribe=function(t,e){return t&&"Already subscribed"!==t?(console.error("Could not subscribe:",t,this.collection,this.name),this._handleTypedError(t),void this._setWantSubscribe(!1,null,t)):(e&&this.ingestData(e),this.subscribed=!0,this._clearAction(),this.emit("subscribe"),void this._finishSub())},r.prototype._finishQuerySubscribe=function(t){return t>this.version?this.subscribe():(this.subscribed=!0,this.wantSubscribe=!0,this.emit("subscribe"),void this._finishSub())},r.prototype._onMessage=function(t){if(t.c!==this.collection||t.d!==this.name)throw new Error("Got message for wrong document. "+this.collection+" "+this.name);switch(t.a){case"fetch":t.data&&this.ingestData(t.data),"fetch"===this.wantSubscribe&&(this.wantSubscribe=!1),this._clearAction(),this._finishSub(t.error);break;case"sub":this._handleSubscribe(t.error,t.data);break;case"unsub":this.subscribed=!1,this.emit("unsubscribe"),this._clearAction(),this._finishSub(t.error);break;case"ack":t.error&&"Op already submitted"!==t.error&&(this.inflightData?(console.warn("Operation was rejected ("+t.error+"). Trying to rollback change locally."),this._handleTypedError(t.error),this._tryRollback(this.inflightData),this._clearInflightOp(t.error)):console.warn("Second acknowledgement message (error) received",t,this));break;case"op":if(this.inflightData&&t.src===this.inflightData.src&&t.seq===this.inflightData.seq){this._opAcknowledged(t);break}if(t.v<this.version)break;if(t.v>this.version){console.warn("Client got future operation from the server",this.collection,this.name,t),this._getLatestOps();break}this.inflightData&&h(this.inflightData,t);for(var e=0;e<this.pendingData.length;e++)h(this.pendingData[e],t);this.version++,this._otApply(t,!1);break;case"meta":console.warn("Unhandled meta op:",t);break;default:console.warn("Unhandled document message:",t)}},r.prototype._getLatestOps=function(){this._send({a:"fetch",v:this.version})},r.prototype._onConnectionStateChanged=function(t,e){"connecting"===t||"connected"===t?this.flush():"disconnected"===t&&(this._clearAction(),this.subscribed=!1)},r.prototype._clearAction=function(){this.action=null,this.flush(),this.hasPending()||this.emit("nothing pending")},r.prototype.flush=function(){if(this.connection.canSend&&!this.action){if(this.inflightData)return void this._sendOpData();for(var t;this.pendingData.length&&a(t=this.pendingData[0]);){for(var e=t.callbacks,n=0;n<e.length;n++)e[n](t.error);this.pendingData.shift()}!this.paused&&this.pendingData.length&&"connected"===this.connection.state?(this.inflightData=this.pendingData.shift(),this._sendOpData()):this.subscribed&&!this.wantSubscribe?(this.action="unsubscribe",this._send({a:"unsub"})):this.subscribed||"fetch"!==this.wantSubscribe?!this.subscribed&&this.wantSubscribe&&(this.action="subscribe",this.connection.sendSubscribe(this.collection,this.name,"ready"===this.state?this.version:null)):(this.action="fetch",this._send("ready"===this.state?{a:"fetch",v:this.version}:{a:"fetch"}))}},r.prototype._setWantSubscribe=function(t,e,n){return this.subscribed===this.wantSubscribe&&(this.subscribed===t||"fetch"===t&&this.subscribed)?void(e&&e(n)):("fetch"===t&&this.wantSubscribe===!0||(this.wantSubscribe=t),e&&this._subscribeCallbacks.push(e),void this.flush())},r.prototype.subscribe=function(t){this._setWantSubscribe(!0,t)},r.prototype.unsubscribe=function(t){this._setWantSubscribe(!1,t)},r.prototype.fetch=function(t){this._setWantSubscribe("fetch",t)},r.prototype._finishSub=function(t){if(this._subscribeCallbacks.length){for(var e=0;e<this._subscribeCallbacks.length;e++)this._subscribeCallbacks[e](t);this._subscribeCallbacks.length=0}};var s=function(t){delete t.op,delete t.create,delete t.del},a=function(t){return!t.op&&!t.create&&!t.del},c=function(t,e,n){if(e.create&&n.del)s(e);else if(e.create&&n.op){var i=void 0===e.create.data?t.create():e.create.data;e.create.data=t.apply(i,n.op)}else if(a(e))e.create=n.create,e.del=n.del,e.op=n.op;else{if(!(e.op&&n.op&&t.compose))return!1;e.op=t.compose(e.op,n.op)}return!0},h=function(t,e){if(e.create||e.del)return s(t);if(t.create)throw new Error("Invalid state. This is a bug. "+this.collection+" "+this.name);if(t.del)return s(e);if(e.op&&t.op)if(t.type.transformX){var n=t.type.transformX(t.op,e.op);t.op=n[0],e.op=n[1]}else{var i=t.type.transform(t.op,e.op,"left"),o=t.type.transform(e.op,t.op,"right");t.op=i,e.op=o}};r.prototype._otApply=function(t,e){if(this.locked=!0,t.create){var n=t.create;this._setType(n.type),this.snapshot=this.type.create(n.data),this.once("unlock",function(){this.emit("create",e)})}else if(t.del){var i=this.snapshot;this._setType(null),this.once("unlock",function(){this.emit("del",e,i)})}else if(t.op){if(!this.type)throw new Error("Document does not exist. "+this.collection+" "+this.name);for(var o=this.type,r=t.op,s=0;s<this.editingContexts.length;s++){var a=this.editingContexts[s];a!=e&&a._beforeOp&&a._beforeOp(t.op)}if(this.emit("before op",r,e),this.incremental&&o.incrementalApply){var c=this;o.incrementalApply(this.snapshot,r,function(t,n){c.snapshot=n,c.emit("op",t,e)})}else this.snapshot=o.apply(this.snapshot,r),this.emit("op",r,e)}if(this.locked=!1,this.emit("unlock"),t.op){for(var h=this.editingContexts,s=0;s<h.length;s++){var a=h[s];a!=e&&a._onOp&&a._onOp(t.op)}for(var s=0;s<h.length;s++)h.remove&&h.splice(s--,1);return this.emit("after op",t.op,e)}},r.prototype._sendOpData=function(){var t=this.inflightData;if(this.action)throw new Error("Invalid state "+this.action+" for sendOpData. "+this.collection+" "+this.name);this.action="submit",t.sentAt=Date.now(),t.retries=null==t.retries?0:t.retries+1;var e={a:"op",v:this.version};t.src&&(e.src=t.src,e.seq=t.seq),t.op&&(e.op=t.op),t.create&&(e.create=t.create),t.del&&(e.del=t.del),e.c=this.collection,e.d=this.name,this.connection.sendOp(e),t.src||(t.src=this.connection.id,t.seq=this.connection.seq++)},r.prototype._submitOpData=function(t,e,n){"function"==typeof e&&(n=e,e=!0),null==e&&(e=!0);var i=function(t){return n?n(t):void console.warn("Failed attempt to submitOp:",t)};if(this.locked)return i("Cannot call submitOp from inside an 'op' event handler. "+this.collection+" "+this.name);if(t.op){if(!this.type)return i("Document has not been created");this.type.normalize&&(t.op=this.type.normalize(t.op))}this.state||(this.state="floating"),t.type=this.type,t.callbacks=[];var o,r=this.pendingData[this.pendingData.length-1];r&&c(this.type,r,t)?o=r:(o=t,this.pendingData.push(t)),n&&o.callbacks.push(n),this._otApply(t,e);var s=this;setTimeout(function(){s.flush()},0)},r.prototype.submitOp=function(t,e,n){this._submitOpData({op:t},e,n)},r.prototype.create=function(t,e,n,i){"function"==typeof e&&(n=e,e=void 0);var o={create:{type:t,data:e}};return this.type?void(i&&i("Document already exists",this._opErrorContext(o))):void this._submitOpData(o,n,i)},r.prototype.del=function(t,e){return this.type?void this._submitOpData({del:!0},t,e):void(e&&e("Document does not exist"))},r.prototype.pause=function(){this.paused=!0},r.prototype.resume=function(){this.paused=!1,this.flush()},r.prototype._tryRollback=function(t){if(t.create)this._setType(null),"floating"===this.state?this.state=null:console.warn("Rollback a create from state "+this.state);else if(t.op&&t.type.invert){t.op=t.type.invert(t.op);for(var e=0;e<this.pendingData.length;e++)h(this.pendingData[e],t);this._otApply(t,!1);
}else(t.op||t.del)&&(this._setType(null),this.version=null,this.state=null,this.subscribed=!1,this.emit("error","Op apply failed and the operation could not be reverted"),this.fetch(),this.flush())},r.prototype._opErrorContext=function(t){return{collection:this.collection,name:this.name,opData:t||this.inflightData}},r.prototype._clearInflightOp=function(t){for(var e=this.inflightData.callbacks,n=this._opErrorContext(),i=0;i<e.length;i++)e[i](t||this.inflightData.error,n);this.inflightData=null,this._clearAction()},r.prototype._opAcknowledged=function(t){if(!this.state)throw new Error("opAcknowledged called from a null state. This should never happen. "+this.collection+" "+this.name);if("floating"===this.state){if(!this.inflightData.create)throw new Error("Cannot acknowledge an op. "+this.collection+" "+this.name);this.version=t.v,this.state="ready";var e=this;setTimeout(function(){e.emit("ready")},0)}else if(t.v!==this.version)throw new Error("Invalid version from server. This can happen when you submit ops in a submitOp callback. Expected: "+this.version+" Message version: "+t.v+" "+this.collection+" "+this.name);this.version++,this._clearInflightOp()},r.prototype.createContext=function(){var t=this.type;if(!t)throw new Error("Missing type "+this.collection+" "+this.name);var e=this,n={getSnapshot:function(){return e.snapshot},submitOp:function(t,i){e.submitOp(t,n,i)},numberPending:function(){return e.numberPending()},destroy:function(){this.detach&&(this.detach(),delete this.detach),delete this._onOp,this.remove=!0},_doc:this};if(t.api)for(var i in t.api)n[i]=t.api[i];else n.provides={};return this.editingContexts.push(n),n},r.prototype.removeContexts=function(){for(var t=0;t<this.editingContexts.length;t++)this.editingContexts[t].destroy();this.editingContexts.length=0};var r,l,i;"undefined"!=typeof require?(r=require("./doc").Doc,l=require("./query").Query,i=require("./microevent")):(r=n.Doc,l=n.Query);var p=n.Connection=function(t){this.collections={},this.nextQueryId=1,this.queries={},this.state="disconnected",this.canSend=!1,this._retryInterval=null,this.reset(),this.debug=!1,this.messageBuffer=[],this.bindToSocket(t)};i.mixin(p),p.prototype.bindToSocket=function(t){this.socket&&(delete this.socket.onopen,delete this.socket.onclose,delete this.socket.onmessage,delete this.socket.onerror),this.socket=t,this.state=0===t.readyState||1===t.readyState?"connecting":"disconnected",this.canSend="connecting"===this.state&&t.canSendWhileConnecting,this._setupRetry();var e=this;t.onmessage=function(t){var n=t.data;for(n||(n=t),"string"==typeof n&&(n=JSON.parse(n)),e.debug&&console.log("RECV",JSON.stringify(n)),e.messageBuffer.push({t:(new Date).toTimeString(),recv:JSON.stringify(n)});e.messageBuffer.length>100;)e.messageBuffer.shift();try{e.handleMessage(n)}catch(i){throw e.emit("error",i),i}},t.onopen=function(){e._setState("connecting")},t.onerror=function(t){e.emit("connection error",t)},t.onclose=function(t){e._setState("disconnected",t),"Closed"!==t&&"Stopped by server"!==t||e._setState("stopped",t)}},p.prototype.handleMessage=function(t){switch(t.a){case"init":if(0!==t.protocol)throw new Error("Invalid protocol version");if("string"!=typeof t.id)throw new Error("Invalid client id");this.id=t.id,this._setState("connected");break;case"qfetch":case"qsub":case"q":case"qunsub":var e=this.queries[t.id];e&&e._onMessage(t);break;case"bs":var n=t.s;if(t.error&&!t.s){this._handleTypedError(t.error);break}for(var i in n)for(var o in n[i]){var r=this.get(i,o);if(!r){console&&console.error("Message for unknown doc. Ignoring.",t);break}var t=n[i][o];"object"==typeof t?r._handleSubscribe(t.error,t):(console&&console.info("resubscribing with null msg.",t),r._handleSubscribe(null,null))}break;default:var s,o,r;t.d?(s=this._lastReceivedCollection=t.c,o=this._lastReceivedDoc=t.d):(s=t.c=this._lastReceivedCollection,o=t.d=this._lastReceivedDoc);var r=this.getExisting(s,o);r&&r._onMessage(t)}},p.prototype._handleTypedError=function(t){if(t&&"string"==typeof t&&t.length>=7&&"json://"===t.substring(0,7)){var e=t.substring(7),n=JSON.parse(e);if(n.collection&&n.doc){var i=this.get(n.collection,n.doc);i?i.emit("typedError",n):this.emit("error",t)}else this.emit("error",t)}else this.emit("error",t)},p.prototype.reset=function(){this.id=this.lastError=this._lastReceivedCollection=this._lastReceivedDoc=this._lastSentCollection=this._lastSentDoc=null,this.seq=1},p.prototype._setupRetry=function(){if(!this.canSend)return clearInterval(this._retryInterval),void(this._retryInterval=null);if(null==this._retryInterval){var t=this;this._retryInterval=setInterval(function(){for(var e in t.collections){var n=t.collections[e];for(var i in n)n[i].retry()}},1e3)}},p.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state||"connected"===t&&"connecting"!==this.state)throw new Error("Cannot transition directly from "+this.state+" to "+t);this.state=t,this.canSend="connecting"===t&&this.socket.canSendWhileConnecting||"connected"===t,this._setupRetry(),"disconnected"===t&&this.reset(),this.emit(t,e);var n={};for(var i in this.queries){var o=this.queries[i];if(o._onConnectionStateChanged(t,e),"sub"===o.docMode&&("connecting"===t||"connected"===t))for(var r=n[o.collection]||(n[o.collection]={}),s=0;s<o.results.length;s++)r[o.results[s].name]=!0}this.opQueue=[],this.bsStart();for(var a in this.collections){var c=this.collections[a];for(var h in c)n[a]&&n[a][h]||c[h]._onConnectionStateChanged(t,e)}this.opQueue.sort(function(t,e){return t.seq-e.seq});for(var s=0;s<this.opQueue.length;s++)this.send(this.opQueue[s]);this.opQueue=null,this.bsEnd()}},p.prototype.sendOp=function(t){this.opQueue?this.opQueue.push(t):this.send(t)},p.prototype.bsStart=function(){this.subscribeData={}},p.prototype.bsEnd=function(){t(this.subscribeData)&&this.send({a:"bs",s:this.subscribeData}),this.subscribeData=null},p.prototype.sendSubscribe=function(t,e,n){if(this.subscribeData){var i=this.subscribeData;i[t]||(i[t]={}),i[t][e]=n||null}else{var o={a:"sub",c:t,d:e};null!=n&&(o.v=n),this.send(o)}},p.prototype.send=function(t){for(this.debug&&console.log("SEND",JSON.stringify(t)),this.messageBuffer.push({t:Date.now(),send:JSON.stringify(t)});this.messageBuffer.length>100;)this.messageBuffer.shift();if(t.d){var e=t.c,n=t.d;e===this._lastSentCollection&&n===this._lastSentDoc?(delete t.c,delete t.d):(this._lastSentCollection=e,this._lastSentDoc=n)}this.socket.canSendJSON||(t=JSON.stringify(t)),this.socket.send(t)},p.prototype.disconnect=function(){this.socket.close()},p.prototype.getExisting=function(t,e){if(this.collections[t])return this.collections[t][e]},p.prototype.getOrCreate=function(t,e,n){return console.trace("getOrCreate is deprecated. Use get() instead"),this.get(t,e,n)},p.prototype.get=function(t,e,n){var i=this.collections[t];i||(i=this.collections[t]={});var o=i[e];return o||(o=i[e]=new r(this,t,e)),n&&void 0!==n.data&&!o.state&&o.ingestData(n),o},p.prototype._destroyDoc=function(e){var n=this.collections[e.collection];n&&(delete n[e.name],t(n)||delete this.collections[e.collection])},p.prototype._createQuery=function(t,e,n,i,o){if("fetch"!==t&&"sub"!==t)throw new Error("Invalid query type: "+t);i||(i={});var r=this.nextQueryId++,s=new l(t,this,r,e,n,i,o);return this.queries[r]=s,s._execute(),s},p.prototype._destroyQuery=function(t){delete this.queries[t.id]},p.prototype.createFetchQuery=function(t,e,n,i){return this._createQuery("fetch",t,e,n,i)},p.prototype.createSubscribeQuery=function(t,e,n,i){return this._createQuery("sub",t,e,n,i)};var u=function(t,e,n){if(e!==n){for(var i=0;e.charAt(i)===n.charAt(i);)i++;for(var o=0;e.charAt(e.length-1-o)===n.charAt(n.length-1-o)&&o+i<e.length&&o+i<n.length;)o++;e.length!==i+o&&t.remove(i,e.length-i-o),n.length!==i+o&&t.insert(i,n.slice(i,n.length-o))}};window.collab_service.Doc.prototype.attachTextarea=function(t,e){if(e||(e=this.createContext()),!e.provides.text)throw new Error("Cannot attach to non-text document");t.value=e.get();var n,i=function(e,i){if(i)var o=[i(t.selectionStart),i(t.selectionEnd)];var r=t.scrollTop;t.value=e,n=t.value,t.scrollTop!==r&&(t.scrollTop=r),o&&window.document.activeElement===t&&(t.selectionStart=o[0],t.selectionEnd=o[1])};i(e.get()),e.onInsert=function(e,n){var o=function(t){return e<t?t+n.length:t},r=t.value.replace(/\r\n/g,"\n");i(r.slice(0,e)+n+r.slice(e),o)},e.onRemove=function(e,n){var o=function(t){return e<t?t-Math.min(n,t-e):t},r=t.value.replace(/\r\n/g,"\n");i(r.slice(0,e)+r.slice(e+n),o)};for(var o=function(i){setTimeout(function(){t.value!==n&&(n=t.value,u(e,e.get(),t.value.replace(/\r\n/g,"\n")))},0)},r=["textInput","keydown","keyup","select","cut","paste"],s=0;s<r.length;s++){var a=r[s];t.addEventListener?t.addEventListener(a,o,!1):t.attachEvent("on"+a,o)}return e.detach=function(){for(var e=0;e<r.length;e++){var n=r[e];t.removeEventListener?t.removeEventListener(n,o,!1):t.detachEvent("on"+n,o)}},e};var r;"undefined"!=typeof require&&(r=require("./doc").Doc);var l=n.Query=function(t,e,n,i,o,r,s){this.type=t,this.connection=e,this.id=n,this.collection=i,this.query=o,this.docMode=r.docMode,"subscribe"===this.docMode&&(this.docMode="sub"),this.poll=r.poll,this.backend=r.backend||r.source,this.knownDocs=r.knownDocs||[],this.results=[],this.ready=!1,this.callback=s};l.prototype.action="qsub",l.prototype._execute=function(){if(this.connection.canSend){if(this.docMode)for(var t={},e=0;e<this.knownDocs.length;e++){var n=this.knownDocs[e],i=t[n.collection]=t[n.collection]||{};i[n.name]=n.version}var o={a:"q"+this.type,id:this.id,c:this.collection,o:{},q:this.query};this.docMode&&(o.o.m=this.docMode,o.o.vs=t),null!=this.backend&&(o.o.b=this.backend),void 0!==this.poll&&(o.o.p=this.poll),this.connection.send(o)}},l.prototype._dataToDocs=function(t){for(var e,n=[],i=0;i<t.length;i++){var o=t[i];o.type?e=o.type:o.type=e;var r=this.connection.get(o.c||this.collection,o.d,o);"sub"===this.docMode&&r._finishQuerySubscribe(o.v),n.push(r)}return n},l.prototype.destroy=function(){this.connection.canSend&&"sub"===this.type&&this.connection.send({a:"qunsub",id:this.id}),this.connection._destroyQuery(this)},l.prototype._onConnectionStateChanged=function(t,e){"connecting"===this.connection.state&&this._execute()},l.prototype._onMessage=function(t){if("qfetch"===t.a!=("fetch"===this.type))return void(console&&console.warn("Invalid message sent to query",t,this));switch(t.error&&this.emit("error",t.error),t.a){case"qfetch":var e=t.data?this._dataToDocs(t.data):void 0;this.callback&&this.callback(t.error,e,t.extra),this.connection._destroyQuery(this);break;case"q":if(t.diff){for(var n=0;n<t.diff.length;n++){var i=t.diff[n];"insert"===i.type&&(i.values=this._dataToDocs(i.values))}for(var n=0;n<t.diff.length;n++){var i=t.diff[n];switch(i.type){case"insert":var o=i.values;Array.prototype.splice.apply(this.results,[i.index,0].concat(o)),this.emit("insert",o,i.index);break;case"remove":var r=i.howMany||1,s=this.results.splice(i.index,r);this.emit("remove",s,i.index);break;case"move":var r=i.howMany||1,a=this.results.splice(i.from,r);Array.prototype.splice.apply(this.results,[i.to,0].concat(a)),this.emit("move",a,i.from,i.to)}}}void 0!==t.extra&&this.emit("extra",t.extra);break;case"qsub":if(!t.error){var c=this.results;this.results=this.knownDocs=this._dataToDocs(t.data),this.extra=t.extra,this.ready=!0,this.emit("change",this.results,c)}this.callback&&(this.callback(t.error,this.results,this.extra),delete this.callback)}},l.prototype.setQuery=function(t){if("sub"!==this.type)throw new Error("cannot change a fetch query");this.query=t,this.connection.canSend&&(this.connection.send({a:"qunsub",id:this.id}),this._execute())};var i;"undefined"!=typeof require&&(i=require("./microevent")),i.mixin(l)}();!function(){var n={openAndSubscribe:function(n,o,t,e,r){var i=this,c=t.appsession||"testsession",s=n||"circuits",d=t.authcallkey||"",u=t.formatversion,a=new BCSocket(t.origin,{reconnect:!0,affinity:s+"|"+c+(d?"|"+d:""),crossDomainXhr:!0,appVersion:u}),m=new collab_service.Connection(a),l=m.get(s,o);m.debug=t.debug||!1,i.debug=m.debug,i.durations={},i.sample=!0,i.lastSample=0,l.on("typedError",function(n){i.onError(n)}),l.subscribe(),l.whenReady(function(){if(t.debug&&console.log("SharedDoc ready, data: ",l.getSnapshot()),i.document=l,i.document.constructor){var n=i.document.constructor.prototype._opAcknowledged;i.document.constructor.prototype._opAcknowledged=function(o){var e=i.document.version;i._opWarningTimers[o.v]&&(clearTimeout(i._opWarningTimers[o.v]),delete i._opWarningTimers[o.v]),i.countConnectionErrors&&(i.countConnectionErrors=null),i.durations[e]&&(i.durations[e].end=Date.now(),i.durations[e].tzm=(new Date).getTimezoneOffset(),i.durations[e].oplen=o.op?o.op.length:0,i._profCall(t.origin,s+"|"+c+(d?"|"+d:""),e,i.durations[e])),n.call(i.document,o),i.onOpAcknowledged(o.v,o.op)}}e()})},unsubscribe:function(){this.document.unsubscribe()},init:function(n){var o=this;this.document.getSnapshot()?this.docEditingContext=this.document.createContext():(this.document.create("json0",n||{},function(){}),this.docEditingContext=this.document.createContext()),this.docEditingContext.addListener([],"add",function(n){o.debug&&console.log("added to document: ",JSON.stringify(n))}),this.document.on("after op",function(n,t){t!=o.docEditingContext?(o.debug&&console.log(n),o.afterUpdate&&o.afterUpdate(n,!0)):o.afterUpdate&&o.afterUpdate(n,!1)}),this.document.on("before op",function(n,t){if(t!=o.docEditingContext)o.debug&&console.log(n),o.beforeUpdate&&o.beforeUpdate(n,!0);else{o._opWarningTimers[o.document.version]&&clearTimeout(o._opWarningTimers[o.document.version]);var e=6e4,r=Date.now(),i=function(n){return function(){console.warn("Edit version:",n," not saved since:",Date.now()-r," conn status:",o.document.connection.state),"connected"!==o.document.connection.state&&"connecting"!==o.document.connection.state||o.onWarning&&o.onWarning({type:"slow-submit",msg:"change not yet stored after 1 min",v:n,duration:Date.now()-r}),o._opWarningTimers[n]=setTimeout(i(n),e)}};o._opWarningTimers[o.document.version]=setTimeout(i(o.document.version),e),o.beforeUpdate&&o.beforeUpdate(n,!1)}}),this.document.connection.on("connected",function(n){o.countConnectionErrors&&(o.countConnectionErrors=null),o.onConnected()}),this.document.connection.on("disconnected",function(n){console.warn("temp disconnection, wait to propagate event",n),o.disconnectTimer=setTimeout(function(){"disconnected"===o.document.connection.state&&o.onDisconnected(),o.disconnectTimer=null},3500)}),this.document.connection.on("stopped",function(n){o.onConnectionStopped()}),this.document.connection.on("error",function(n){console.log("error"),o.onConnectionError("error")}),this.document.connection.on("connection error",function(n){console.warn("temp connection error, wait to propagate event",n,o.document.connection.state," count:",o.countConnectionErrors);var t=o.document.connection.state;o.countConnectionErrors=(o.countConnectionErrors||0)+1,o.connectionErrorTimer=setTimeout(function(){"disconnected"===o.document.connection.state?(console.error("propagating connection error event to clients after delay",n,o.document.connection.state," count:",o.countConnectionErrors),o.countConnectionErrors=null,o.onConnectionError("connection error")):o.countConnectionErrors&&o.countConnectionErrors>=3&&o.document.connection.state===t?(console.error("propagating connection error event to clients after delay",n,o.document.connection.state," count:",o.countConnectionErrors),o.countConnectionErrors=null,o.onConnectionError("connection error")):o.document.connection.state!==t&&(o.countConnectionErrors=null),o.connectionErrorTimer=null},5e3)})},snapshot:function(){return this.document.getSnapshot()},onError:function(n){console.log("triggered typed error:",n)},onOpError:function(n){console.log("triggered op error:",n)},onConnectionError:function(n){},onConnected:function(){},onDisconnected:function(){},onConnectionStopped:function(){},onWarning:function(n){console.warn("triggered warning:",n)},onOpAcknowledged:function(n,o){},beforeUpdate:function(n,o){},afterUpdate:function(n,o){},numberPending:function(){return this.docEditingContext.numberPending()},submitOp:function(n,o){this.docEditingContext.submitOp(n,o)},get:function(n){return this.docEditingContext.get(n)},set:function(n,o){return this.durations[this.document.version]={start:Date.now()},this.docEditingContext.set(n,o)},push:function(n,o){return this.durations[this.document.version]={start:Date.now()},this.docEditingContext.push(n,o)},insert:function(n,o){return this.durations[this.document.version]={start:Date.now()},this.docEditingContext.insert(n,o)},remove:function(n){return this.docEditingContext.remove(n)},_profCall:function(n,o,t,e){if(t%(Math.round(5*Math.random())+10)===0){var r=new XMLHttpRequest,i=document.createElement("a");i.href=n;var c="https://"+i.host+"/prf/"+this.document.collection+"/"+this.document.name+"?a="+escape(o);r.withCredentials=!0,r.open("post",c,!0),r.send(JSON.stringify(e))}},_opWarningTimers:{}};window.adsk=window.adsk||{},adsk.collaboration=adsk.collaboration||{},window.adsk.collaboration.SharedDoc=n,window.adsk.collaboration.onLoad&&window.adsk.collaboration.onLoad()}();